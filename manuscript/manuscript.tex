%% Copernicus Publications Manuscript Preparation Template for LaTeX Submissions
%% ---------------------------------
%% This template should be used for copernicus.cls
%% The class file and some style files are bundled in the Copernicus Latex Package which can be downloaded from the different journal webpages.
%% For further assistance please contact the Copernicus Publications at: publications@copernicus.org
%% http://publications.copernicus.org


%% Please use the following documentclass and Journal Abbreviations for Discussion Papers and Final Revised Papers.


%% 2-Column Papers and Discussion Papers
\documentclass[gmd, manuscript]{copernicus}



%% Journal Abbreviations (Please use the same for Discussion Papers and Final Revised Papers)

% Archives Animal Breeding (aab)
% Atmospheric Chemistry and Physics (acp)
% Advances in Geosciences (adgeo)
% Advances in Statistical Climatology, Meteorology and Oceanography (ascmo)
% Annales Geophysicae (angeo)
% ASTRA Proceedings (ap)
% Atmospheric Measurement Techniques (amt)
% Advances in Radio Science (ars)
% Advances in Science and Research (asr)
% Biogeosciences (bg)
% Climate of the Past (cp)
% Drinking Water Engineering and Science (dwes)
% Earth System Dynamics (esd)
% Earth Surface Dynamics (esurf)
% Earth System Science Data (essd)
% Fossil Record (fr)
% Geographica Helvetica (gh)
% Geoscientific Instrumentation, Methods and Data Systems (gi)
% Geoscientific Model Development (gmd)
% Geothermal Energy Science (gtes)
% Hydrology and Earth System Sciences (hess)
% History of Geo- and Space Sciences (hgss)
% Journal of Sensors and Sensor Systems (jsss)
% Mechanical Sciences (ms)
% Natural Hazards and Earth System Sciences (nhess)
% Nonlinear Processes in Geophysics (npg)
% Ocean Science (os)
% Proceedings of the International Association of Hydrological Sciences (piahs)
% Primate Biology (pb)
% Scientific Drilling (sd)
% SOIL (soil)
% Solid Earth (se)
% The Cryosphere (tc)
% Web Ecology (we)
% Wind Energy Science (wes)


%% \usepackage commands included in the copernicus.cls:
%\usepackage[german, english]{babel}
%\usepackage{tabularx}
%\usepackage{cancel}
%\usepackage{multirow}
%\usepackage{supertabular}
%\usepackage{algorithmic}
%\usepackage{algorithm}
%\usepackage{amsthm}
%\usepackage{float}
%\usepackage{subfig}
%\usepackage{rotating}


\begin{document}

\title{3D Magnetic modelling of ellipsoidal bodies}


% \Author[affil]{given_name}{surname}

\Author[1]{Diego}{Takahashi Tomazella}
\Author[1]{Vanderlei}{C. Oliveira Jr}

\affil[1]{Department of Geophysics, Observat\'{o}rio Nacional, Rio de Janeiro, Brazil}
%\affil[]{}

%% The [] brackets identify the author with the corresponding affiliation. 1, 2, 3, etc. should be inserted.



\runningtitle{TEXT}

\runningauthor{TEXT}

\correspondence{Diego Takahashi Tomazella (diego.takahashi@gmail.com)}



\received{}
\pubdiscuss{} %% only important for two-stage journals
\revised{}
\accepted{}
\published{}

%% These dates will be inserted by Copernicus Publications during the typesetting process.


\firstpage{1}

\maketitle



\begin{abstract}

TEXT

\end{abstract}



\introduction  %% \introduction[modified heading if necessary]

TEXT

\section{Methodology}


\subsection{Geometrical parameters and coordinate systems}

Let $(x, y, z)$ be a point referred to a Cartesian coordinate system with axes
$x$, $y$ and $z$ pointing to, respectively, North, East and down.
For convenience, we denominate this coordinate system as 
\textit{main coordinate system}.
Let us consider an ellipsoidal body with centre at the point $(x_{c}, y_{c}, z_{c})$,
semi-axes defined by positive constants $a$, $b$, $c$, 
where $a > b > c$, and orientation defined by
three angles $\alpha$, $\beta$, and $\gamma$.
The points $(x, y, z)$ located on the surface of this ellipsoidal body
satisfy the following equation:
\begin{equation}
(\mathbf{r} - \mathbf{r}_c)^T \mathbf{A} (\mathbf{r} - \mathbf{r}_c) = 1 \: ,
\label{eq:ellipsoid_surface}
\end{equation}
where $\mathbf{r} = [\begin{array}{ccc} x & y & z \end{array} ]^{\top}$,
$\mathbf{r}_{c} = [\begin{array}{ccc} x_{c} & y_{c} & z_{c} \end{array} ]^{\top}$,
$\mathbf{A}$ is a positive definite matrix given by
\begin{equation}
\mathbf{A} = \mathbf{V}
\left[ \begin{array}{ccc}
a^{-2} & 0 & 0 \\
0 & b^{-2} & 0 \\
0 & 0 & c^{-2} 
\end{array} \right] \mathbf{V}^{\top} \: ,
\label{eq:A}
\end{equation}
and $\mathbf{V}$ is an orthogonal matrix whose columns are defined
by unit vectors $\mathbf{v}_{1}$, $\mathbf{v}_{2}$, and $\mathbf{v}_{3}$.

The vectors $\mathbf{v}_{1}$, $\mathbf{v}_{2}$, and $\mathbf{v}_{3}$ 
depend on the orientation angles 
$\alpha$, $\beta$, $\gamma$ and are defined 
as follows \citep{clark1986}:
\begin{equation}
\mathbf{v}_{1} = \left[\begin{array}{c} 
                  -\cos\alpha \; \cos\delta \\
                  -\sin\alpha \; \cos\delta \\
                  -\sin\delta
                  \end{array} \right] \: ,
\label{eq:v1_triaxial_prolate}
\end{equation}
\begin{equation}
\mathbf{v}_{2} = \left[\begin{array}{c} 
                  \cos\alpha \; \cos\gamma \; \sin\delta + \sin\alpha \; \sin\gamma \\                   
                  \sin\alpha \; \cos\gamma \; \sin\delta - \cos\alpha \; \sin\gamma \\ 
                  -\cos\gamma \; \cos\delta
                  \end{array} \right] \: ,
\label{eq:v2_triaxial_prolate}
\end{equation}                   
\begin{equation}                    
\mathbf{v}_{3} = \left[\begin{array}{c} 
                  \sin\alpha \; \cos\gamma - \cos\alpha \; \sin\gamma \; \sin\delta \\                    
                  -\cos\alpha \; \cos\gamma - \sin\alpha \; \sin\gamma \; \sin\delta \\
                  \sin\gamma \; \cos\delta
                  \end{array} \right] \: .
\label{eq:v3_triaxial_prolate}
\end{equation}
For triaxial ellipsoids (i.e., $a > b > c$), the orthogonal matrix
$\mathbf{V}$ (equation \ref{eq:A}) is calculated by using equations
\ref{eq:v1_triaxial_prolate}, \ref{eq:v2_triaxial_prolate}, and
\ref{eq:v3_triaxial_prolate} as follows:
\begin{equation}
\mathbf{V} = \left[ \begin{array}{ccc}
\mathbf{v}_{1} & \mathbf{v}_{2} & \mathbf{v}_{3}
\end{array} \right] \: .
\label{eq:V_triaxial_prolate}
\end{equation}
Similarly, the matrix $\mathbf{V}$ (equation \ref{eq:A}) for
prolate ellipsoids (i.e., $a > b = c$) is calculated according
to equation \ref{eq:V_triaxial_prolate} by using equations
\ref{eq:v1_triaxial_prolate}, \ref{eq:v2_triaxial_prolate}, and
\ref{eq:v3_triaxial_prolate}, but with $\gamma = 0^{\circ}$ 
\citep{emerson1985}.
Finally, the matrix $\mathbf{V}$ (equation \ref{eq:A}) for
oblate ellipsoids (i.e., $a < b = c$) is calculated by 
using equations \ref{eq:v1_triaxial_prolate}, \ref{eq:v2_triaxial_prolate}, and
\ref{eq:v3_triaxial_prolate}, with $\gamma = 0^{\circ}$, as follows
\citep{emerson1985}:
\begin{equation}
\mathbf{V} = \left[ \begin{array}{ccc}
\mathbf{v}_{2} & \mathbf{v}_{1} & -\mathbf{v}_{3}
\end{array} \right] \: .
\label{eq:V_oblate}
\end{equation}
The orientation of the semi-axes $a$, $b$, and $c$ are defined 
by the first, second, and third columns of the matrix 
$\mathbf{V}$ given by equation \ref{eq:V_triaxial_prolate},
in the case of a triaxial or prolate ellipsoid, or the
matrix $\mathbf{V}$ given by equation \ref{eq:V_oblate},
in the case of an oblate ellipsoid.

The magnetic modelling of an ellipsoidal body is commonly performed
in a particular Cartesian coordinate system that is aligned 
with the body semi-axes
and has the origin coincident with the body centre.
For convenience, we denominate this particular coordinate 
system as \textit{local coordinate system}.
The relationship between the Cartesian coordinates 
$(\tilde{x}, \tilde{y}, \tilde{z})$ of a point in 
a local coordinate system and the Cartesian 
coordinates $(x, y, z)$ of the same point in the main
system is given by:
\begin{equation}
\tilde{\mathbf{r}} = \mathbf{V}^{\top} \left( \mathbf{r} - \mathbf{r}_{c} \right) \: ,
\label{eq:coord_transformation}
\end{equation}
where 
$\tilde{\mathbf{r}} = [\begin{array}{ccc} \tilde{x} & 
                                          \tilde{y} & 
                                          \tilde{z} \end{array} ]^{\top}$,
$\mathbf{r}$ and $\mathbf{r}_{c}$
are defined in equation \ref{eq:ellipsoid_surface} and the matrix $\mathbf{V}$
is defined according to equations \ref{eq:V_triaxial_prolate} or
\ref{eq:V_oblate}, depending on the ellipsoid type.
%Similarly, we may properly use the orthogonality of 
%matrix $\mathbf{V}$ to transform a generic 
%linear system $\mathbf{M} \mathbf{p} = \mathbf{d}$,
%referred to the main coordinate system, into a new
%linear system 
%$\tilde{\mathbf{M}} \, \tilde{\mathbf{p}} = \tilde{\mathbf{d}}$,
%referred to a local coordinate system, 
%as follows:
%\begin{equation}
%\underbrace{\mathbf{V}^{\top} \mathbf{M} \mathbf{V}}_{\tilde{\mathbf{M}}} \, 
%\underbrace{\mathbf{V}^{\top} \mathbf{p}}_{\tilde{\mathbf{p}}} = 
%\underbrace{\mathbf{V}^{\top} \mathbf{d}}_{\tilde{\mathbf{d}}} \: .
%\label{eq:matrix-transformation}
%\end{equation}

\subsection{Theoretical background}

Based on the mathematical theory of the magnetic 
induction developed by \citet{poisson1824}, 
\citet{maxwell1873} affirmed that, if $V$ is the 
gravitational potential produced by any body 
with uniform density $\rho$ and arbitrary shape at 
a point $(x, y, z)$, then $-\frac{\partial V}{\partial x}$
is the magnetic scalar potential produced 
at the same point by the same body 
if it has a uniform magnetization oriented along $x$ 
with intensity $\rho$.
\citet{maxwell1873} generalized this idea as a way
of determining the magnetic scalar potential produced
by any body uniformly magnetized in a given direction.
By presuming that this uniform magnetization is due to
induction, he postulated that the resulting magnetic
field (intensity) at all points within the body must
also be uniform and parallel the magnetization, which
results that the gravitational potential $V$ at points
within the body must be a quadratic function of the
spatial coordinates.
Apparently, \citet{maxwell1873} was the first one to
affirm that the only finite bodies having a gravitational
potential with this property and that, as a consequence,
can be uniformly magnetized in the presence of a uniform and 
static magnetic field are the ones bounded by surfaces 
of second degree, which are ellipsoids.

Consider a magnetized ellipsoid immersed in
a uniform magnetic field $\mathbf{H}_{0}$ (in $\unit{Am^{-1}}$).
In the absence of conduction currents, 
the total magnetic field $\mathbf{H}(\mathbf{r})$
at the position $\mathbf{r}$ (equations \ref{eq:A} and 
\ref{eq:coord_transformation}) of a point referred to the main 
coordinate system is defined as follows \citep{sttraton2007}:
\begin{equation}
\mathbf{H}(\mathbf{r}) = \mathbf{H}_{0} - \nabla \phi(\mathbf{r}) \: ,
\label{eq:total-H-field}
\end{equation}
where the second term is the negative gradient of 
the magnetic scalar potential $\phi(\mathbf{r})$ given by:
\begin{equation}
\phi(\mathbf{r}) = -\frac{1}{4\pi} \iiint_{V} 
\mathbf{M}(\mathbf{r}^{\prime})^{\top} 
\nabla \left(
\frac{1}{\| \mathbf{r} - \mathbf{r}^{\prime} \|}
\right) \, dx^{\prime}dy^{\prime}dz^{\prime} \: .
\label{eq:phi-potential}
\end{equation}
In this equation, $\mathbf{r}^{\prime} = [\begin{array}{ccc} 
x^{\prime} & y^{\prime} & z^{\prime} \end{array} ]^{\top}$
is the position vector of a point located within the volume $V$, 
the integral is conducted over the variables 
$x^{\prime}$, $y^{\prime}$ and, $z^{\prime}$ representing
the coordinates of a point located within the volume $V$
of the ellipsoid, $\| \cdot \|$ denotes the Euclidean norm and 
$\mathbf{M}(\mathbf{r}^{\prime})$ is the magnetization vector
(in $\unit{Am^{-1}}$).
Equation \ref{eq:phi-potential} is valid anywhere, 
independently if the position vector $\mathbf{r}$ represents
a point located inside or outside the magnetized body
\citep{dubois1896}.

Based on \citeauthor{maxwell1873}'s postulate, let us
assume that the body has a uniform magnetization given by
\begin{equation}
\mathbf{M} = \mathbf{K} \, \mathbf{H}_{i} \: ,
\label{eq:M-KH}
\end{equation}
where $\mathbf{H}_{i}$ is the resultant uniform magnetic field 
at any point within the body and $\mathbf{K}$ is a 
constant and symmetrical 2nd-order tensor representing the 
magnetic susceptibility of the body. In this case, equation 
\ref{eq:total-H-field} can be rewritten as follows:
\begin{equation}
\mathbf{H}(\mathbf{r}) = \mathbf{H}_{0} 
- \mathbf{N}(\mathbf{r}) \, \mathbf{K} \, \mathbf{H}_{i} \: ,
\label{eq:total-H-field-M-uniform}
\end{equation}
where $\mathbf{N}(\mathbf{r})$ is a symmetrical matrix whose
$ij$-element $n_{ij}(\mathbf{r})$ is given by
\begin{equation}
n_{ij}(\mathbf{r}) = - 
\frac{1}{4\pi} \frac{\partial^{2} \, f(\mathbf{r})}
{\partial r_{i} \, \partial r_{j}} 
\: , \quad i = 1, 2, 3 \: , 
\quad j = 1, 2, 3 \: ,
\label{eq:nij}
\end{equation}
$r_{1} = x$, $r_{2} = y$, $r_{3} = z$ are the elements of 
the position vector $\mathbf{r}$ (equation \ref{eq:ellipsoid_surface}), 
and
\begin{equation}
f(\mathbf{r}) = \iiint_{V} 
\frac{1}{\| \mathbf{r} - \mathbf{r}^{\prime} \|}
\, dx^{\prime}dy^{\prime}dz^{\prime} \: .
\label{eq:f}
\end{equation}
Notice that the scalar function $f(\mathbf{r})$ 
(equation \ref{eq:f}) is proportional
to the gravitational potential that would be produced by the 
ellipsoidal body with volume $V$ if it had a uniform density 
equal to the inverse of the gravitational constant.
It can be shown that the elements $n_{ij}(\mathbf{r})$ are
finite whether $\mathbf{r}$ is a point within or without
the volume $V$ \citep{peirce1902, webster1904}.
The matrix $\mathbf{N}(\mathbf{r})$ (equation \ref{eq:total-H-field-M-uniform})
is called \textit{depolarization tensor} \citep{soliverez1981, soliverez2008}.

The following part of this paper moves on to describe 
the magnetic field $\mathbf{H}(\mathbf{r})$ 
(equation \ref{eq:total-H-field-M-uniform}) at points located
both within and without the volume $V$ of the ellipsoidal
body. However, the mathematical developments are conveniently 
done in the local coordinate system related to the
respective ellipsoidal body. 

\subsection{Coordinate transformation}

Let $\tilde{f}(\tilde{\mathbf{r}})$ be the scalar function
obtained by transforming $f(\mathbf{r})$ (equation \ref{eq:f})
from the main coordinate system to a local coordinate system.
The function $\tilde{f}(\tilde{\mathbf{r}})$ was first 
presented by \citet{dirichlet1839} to describe the gravitational potential
produced by homogeneous ellipsoids.
Posteriorly, several authors also deduced and used this function
for describing the magnetic and gravitational fields produced
by triaxial, prolate, and/or oblate ellipsoids  
\citep{maxwell1873, thomson1879, dubois1896, 
peirce1902, webster1904, kellogg1929, stoner1945, osborn1945,
lowes1974,  peake1953, chang1961, clark1986, tejedor1995, sttraton2007}.
It is convenient to use $\tilde{f}_{i}(\tilde{\mathbf{r}})$
and $\tilde{f}_{e}(\tilde{\mathbf{r}})$ to define 
the function $\tilde{f}(\tilde{\mathbf{r}})$ evaluated, 
respectively, at points 
$\tilde{\mathbf{r}}$ inside and outside the volume $V$ of the
ellipsoidal body.

By following \citet{webster1904}, $\tilde{f}_{i}(\tilde{\mathbf{r}})$
is given by
\begin{equation}
\tilde{f}_{i}(\tilde{\mathbf{r}}) = \pi \, abc \, 
\int_{0}^{\infty} \left( 1 
- \frac{\tilde{x}^{2}}{a^{2} + u} 
- \frac{\tilde{y}^{2}}{b^{2} + u}
- \frac{\tilde{z}^{2}}{c^{2} + u} \right)
\frac{1}{R(u)} \, du \: , \quad \tilde{\mathbf{r}} \in V \: ,
\label{eq:fi-tilde}
\end{equation}
where
\begin{equation}
R(u) = \sqrt{\left( a^{2} + u \right)\left( b^{2} + u \right)\left( c^{2} + u \right)} \: .
\label{eq:R}
\end{equation}
This function represents the gravitational potential
that would be produced by the ellipsoidal body at
points located within its volume $V$ if it
had a uniform density equal to the inverse of the
gravitational constant.
Notice that, in this case, the gravitational potential
is a quadratic function of the spatial coordinates
$\tilde{x}$, $\tilde{y}$, and $\tilde{z}$, which
supported the \citeauthor{maxwell1873}'s (\citeyear{maxwell1873})
postulate about uniformly magnetized ellipsoids.

In a similar way, the function $\tilde{f}_{e}(\tilde{\mathbf{r}})$
is given by \citep{webster1904}
\begin{equation}
\tilde{f}_{e}(\tilde{\mathbf{r}}) = \pi \, abc \, 
\int_{\lambda}^{\infty} \left( 1 
- \frac{\tilde{x}^{2}}{a^{2} + u} 
- \frac{\tilde{y}^{2}}{b^{2} + u}
- \frac{\tilde{z}^{2}}{c^{2} + u} \right)
\frac{1}{R(u)} \, du \: , \quad \tilde{\mathbf{r}} \not\in V \: ,
\label{eq:fe-tilde}
\end{equation}
where $R(u)$ is defined by equation \ref{eq:R} and the
parameter $\lambda$ is a constant defining the integral 
lower limit.

The parameter $\lambda$ is defined according to the
ellipsoid type. Details about the mathematical meaning
of this parameter are given in Appendix B.

PAREI AQUI


By properly using the orthogonality of matrix $\mathbf{V}$ 
(equations \ref{eq:V_triaxial_prolate} and \ref{eq:V_oblate}),
the magnetic field $\mathbf{H}(\mathbf{r})$ 
(equation \ref{eq:total-H-field-M-uniform}) can be transformed
from the main coordinate system to a local coordinate system
as follows:
\begin{equation}
\underbrace{\mathbf{V}^{\top} \mathbf{H}(\mathbf{r})}_{\tilde{\mathbf{H}}(\tilde{\mathbf{r}})} = 
\underbrace{\mathbf{V}^{\top} \mathbf{H}_{0}}_{\tilde{\mathbf{H}}_{0}}
- \underbrace{\mathbf{V}^{\top} \mathbf{N}(\mathbf{r}) \mathbf{V}}
_{\tilde{\mathbf{N}}(\tilde{\mathbf{r}})} \;
\underbrace{\mathbf{V}^{\top} \mathbf{K} \mathbf{V}}
_{\tilde{\mathbf{K}}} \; 
\underbrace{\mathbf{V}^{\top} \mathbf{H}_{i}}
_{\tilde{\mathbf{H}}_{i}} \: ,
\label{eq:total-H-field-local-system}
\end{equation}
where the superscript "$\sim$" denotes quantities
referred to the respective local coordinate system.

In equation \ref{eq:total-H-field-local-system}, the transformed
depolarization tensor $\tilde{\mathbf{N}}(\tilde{\mathbf{r}})$
is calculated as a function of the original depolarization
tensor $\mathbf{N}(\mathbf{r})$ (equation \ref{eq:total-H-field-M-uniform}).
In this case, the elements of $\tilde{\mathbf{N}}(\tilde{\mathbf{r}})$
are calculated as a function of the second derivatives of the
function $f(\mathbf{r})$ (equation \ref{eq:f}),
which is defined in the main coordinate system.
It can be shown (Appendix A), however, that the
elements $\tilde{n}_{ij}(\tilde{\mathbf{r}})$ of
$\tilde{\mathbf{N}}(\tilde{\mathbf{r}})$ can also be calculated
as follows:
\begin{equation}
\tilde{n}_{ij}(\tilde{\mathbf{r}}) = - 
\frac{1}{4\pi} \frac{\partial^{2} \, \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{i} \, \partial \tilde{r}_{j}} 
\: , \quad i = 1, 2, 3 \: , \quad j = 1, 2, 3 \: ,
\label{eq:nij-tilde}
\end{equation}
where $\tilde{r}_{1} = \tilde{x}$, $\tilde{r}_{2} = \tilde{y}$, 
and $\tilde{r}_{3} = \tilde{z}$ are the elements of the
transformed vector $\tilde{\mathbf{r}}$ (equation \ref{eq:coord_transformation})
and $\tilde{f}(\tilde{\mathbf{r}})$ is a scalar function
obtained by transforming $f(\mathbf{r})$ (equation \ref{eq:f})
from the main coordinate system to the respective local
coordinate system.

\subsubsection{Internal magnetic field and demagnetization}

By considering $\mathbf{r}$ as a point internal to the
volume $V$ of the ellipsoid and using the Maxwell's postulate 
about the uniformity of the magnetic field $\mathbf{H}(\mathbf{r})$ 
inside ellipsoidal bodies, we can rewrite equation \ref{eq:total-H-field-local-system}
as follows:
%\begin{equation}
%
%\label{eq:total-Hi-local-system}
%\end{equation}

\subsubsection{External magnetic induction}


\conclusions  %% \conclusions[modified heading if necessary]
TEXT




\appendix
\section{Relationship between the derivatives of the functions $f(\mathbf{r})$ and $\tilde{f}(\tilde{\mathbf{r}})$}    %% Appendix A

Let $\tilde{f}(\tilde{\mathbf{r}})$ the scalar
function obtained by transforming $f(\mathbf{r})$ 
(equation \ref{eq:f}) from the
main coordinate system to a local coordinate system.

For convenience, let us rewrite equation 
\ref{eq:coord_transformation} as follows:
\begin{equation}
\tilde{r}_{k} = v_{k1} \, r_{1} + v_{k2} \, r_{2} + v_{k3} \, r_{3} + c_{k} \: ,
\label{eq:r-tilde-k}
\end{equation}
where $r_{j}$, $j = 1, 2, 3$, are the elements of the position vector
$\mathbf{r}$ (equation \ref{eq:ellipsoid_surface}),
$v_{kj}$, $j = 1, 2, 3$, are the elements of the matrix
$\mathbf{V}$ (equation \ref{eq:V_triaxial_prolate} or \ref{eq:V_oblate}),
and $c_{k}$ is a constant defined by the coordinates
$x_{c}$, $y_{c}$, and $z_{c}$ of the centre of the ellipsoid body.

By considering the functions $f(\mathbf{r})$ 
(equation \ref{eq:f}) and $\tilde{f}(\tilde{\mathbf{r}})$
evaluated at the same point, but on different coordinate
systems, we have:
\begin{equation*}
\frac{\partial f(\mathbf{r})}{\partial r_{j}} = 
\frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{1}} \,
\frac{\partial \tilde{r}_{1}}{\partial r_{j}} +
\frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{2}} \,
\frac{\partial \tilde{r}_{2}}{\partial r_{j}} +
\frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{3}} \,
\frac{\partial \tilde{r}_{3}}{\partial r_{j}} \: ,
\quad j = 1, 2, 3 \: ,
\end{equation*}
which, from equation \ref{eq:r-tilde-k}, can be given by
\begin{equation}
\frac{\partial f(\mathbf{r})}{\partial r_{j}} = 
v_{j1} \, \frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{1}} +
v_{j2} \, \frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{2}} +
v_{j3} \, \frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{3}} \: ,
\quad j = 1, 2, 3 \: .
\label{eq:df_drj}
\end{equation}

Now, by deriving $\frac{\partial f(\mathbf{r})}{\partial r_{j}}$
(equation \ref{eq:df_drj}) with respect to the $i$th element 
$r_{i}$ of the position vector $\mathbf{r}$ (equation \ref{eq:ellipsoid_surface}),
we obtain:
\begin{equation}
\begin{split}
\frac{\partial^{2} f(\mathbf{r})}{\partial r_{i} \, \partial r_{j}} &=
v_{j1} \, \frac{\partial}{\partial r_{i}} 
\left( \frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{1}} \right) +
v_{j2} \, \frac{\partial}{\partial r_{i}} 
\left( \frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{2}} \right) +
v_{j3} \, \frac{\partial}{\partial r_{i}} 
\left( \frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{3}} \right) \\
&= v_{j1} \, \left( 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{1} \, \partial \tilde{r}_{1}} \, v_{i1} + 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{2} \, \partial \tilde{r}_{1}} \, v_{i2} + 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{3} \, \partial \tilde{r}_{1}} \, v_{i3} 
\right) + \\
&+ v_{j2} \, \left( 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{1} \, \partial \tilde{r}_{2}} \, v_{i1} + 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{2} \, \partial \tilde{r}_{2}} \, v_{i2} + 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{3} \, \partial \tilde{r}_{2}} \, v_{i3} 
\right) + \\
&+ v_{j3} \, \left( 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{1} \, \partial \tilde{r}_{3}} \, v_{i1} + 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{2} \, \partial \tilde{r}_{3}} \, v_{i2} + 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{3} \, \partial \tilde{r}_{3}} \, v_{i3} 
\right) \\
&= \left[ \begin{array}{ccc}
v_{j1} & v_{j2} & v_{j3}
\end{array} \right] \tilde{\mathbf{F}}(\tilde{\mathbf{r}})
\left[ \begin{array}{c}
v_{i1} \\ v_{i2} \\ v_{i3}
\end{array} \right]
\end{split} \: ,
\label{eq:d2f-dridrj}
\end{equation}
where $\tilde{\mathbf{F}}(\tilde{\mathbf{r}})$ is a $3 \times 3$
matrix whose $ij$-th element is 
$\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{i} \, \partial \tilde{r}_{j}}$.
From equation \ref{eq:d2f-dridrj}, we obtain
\begin{equation}
\mathbf{F}(\mathbf{r}) = \mathbf{V} \, 
\tilde{\mathbf{F}}(\tilde{\mathbf{r}}) \, \mathbf{V}^{\top} \: ,
\label{eq:F-V-F-tilde-VT}
\end{equation}
where $\mathbf{F}(\mathbf{r})$ is a $3 \times 3$
matrix whose $ij$-th element is 
$\frac{\partial^{2} f(\mathbf{r})}
{\partial r_{i} \, \partial r_{j}}$ and
$\mathbf{V}$ is defined by equations 
\ref{eq:V_triaxial_prolate} or
\ref{eq:V_oblate}, depending on the ellipsoid
type. As one may noticed, the matrices $\mathbf{F}(\mathbf{r})$ and
$\tilde{\mathbf{F}}(\tilde{\mathbf{r}})$ represent the Hessians
of the functions $f(\mathbf{r})$ (equation \ref{eq:f})
and $\tilde{f}(\tilde{\mathbf{r}})$, respectively.
Besides, the depolarization tensor $\mathbf{N}(\mathbf{r})$
(equation \ref{eq:total-H-field-M-uniform}) can be 
rewritten by using the matrix $\mathbf{F}(\mathbf{r})$
as follows
\begin{equation}
\mathbf{N}(\mathbf{r}) = - \frac{1}{4 \pi} \mathbf{F}(\mathbf{r}) \: .
\label{eq:N-F}
\end{equation}
By properly using the orthogonality of the matrix
$\mathbf{V}$, we may rewrite equation \ref{eq:F-V-F-tilde-VT}
as follows:
\begin{equation}
\tilde{\mathbf{F}}(\tilde{\mathbf{r}}) = \mathbf{V}^{\top} \, 
\mathbf{F}(\mathbf{r}) \, \mathbf{V} \: .
\label{eq:F-tilde-VT-F-V}
\end{equation}
Finally, by multiplying both sides of equation \ref{eq:F-tilde-VT-F-V}
by $-\frac{1}{4 \pi}$ and using equations \ref{eq:N-F}
and \ref{eq:total-H-field-local-system}, we conclude that 
\begin{equation}
\tilde{\mathbf{N}}(\tilde{\mathbf{r}}) = 
- \frac{1}{4 \pi} 
\tilde{\mathbf{F}}(\tilde{\mathbf{r}}) \: .
\label{eq:N-tilde-F-tilde}
\end{equation}

\section{Parameter $\lambda$ and its spatial derivatives}    %% Appendix B

Here, we follow the reasoning presented by \citet{webster1904}
for analysing the parameter $\lambda$ describing triaxial, prolate
and oblate ellipsoids.

\subsection{Parameter $\lambda$ defining triaxial ellipsoids} %% Appendix A1, A2, etc.

Let us consider an ellipsoid with semi-axes $a$, $b$, $c$ oriented along 
the $\tilde{x}$-, $\tilde{y}$-, and $\tilde{z}$-axis, respectively, 
of its local coordinate system, where $a > b > c > 0$. 
This ellipsoid is defined by the following equation:
\begin{equation}
\frac{\tilde{x}^{2}}{a^{2}} + \frac{\tilde{y}^{2}}{b^{2}} + \frac{\tilde{z}^{2}}{c^{2}} = 1 \: .
\label{eq:reference-triaxial-ell}
\end{equation}
A quadric surface which is confocal with the ellipsoid defined in 
equation \ref{eq:reference-triaxial-ell} can be described as 
follows:
\begin{equation}
\frac{\tilde{x}^{2}}{a^{2} + u} + \frac{\tilde{y}^{2}}{b^{2} + u} + \frac{\tilde{z}^{2}}{c^{2} + u} = 1 \: ,
\label{eq:quadric-confocal-triaxial-ell}
\end{equation}
where $u$ is a real number. We know that \ref{eq:quadric-confocal-triaxial-ell} 
represents an ellipsoid for $u$ satisfying the condition
\begin{equation}
u + c^{2} > 0 \: .
\label{eq:condition-triaxial-ell}
\end{equation}

Given $a$, $b$, $c$, and a $u$ satisfying \ref{eq:condition-triaxial-ell}, 
we may use \ref{eq:quadric-confocal-triaxial-ell} for determining a set of 
points $(x, y, z)$ lying on the surface of an ellipsoid which is confocal 
with that one defined in equation \ref{eq:reference-triaxial-ell}. 
Now, consider the problem of determining the ellipsoid which is confocal 
with that one defined in \ref{eq:reference-triaxial-ell} and pass through 
a particular point $(\tilde{x}, \tilde{y}, \tilde{z})$. 
This problem consists in determining the real number $u$ that, 
given $a$, $b$, $c$, $\tilde{x}$, $\tilde{y}$, and $\tilde{z}$, 
satisfies the condition expressed by equation \ref{eq:condition-triaxial-ell}.
By rearranging equation \ref{eq:quadric-confocal-triaxial-ell}, 
we obtain the following cubic equation for $u$:
\begin{equation}
p(u) = (a^{2} + u)(b^{2} + u)(c^{2} + u) - (b^{2} + u)(c^{2} + u) \, \tilde{x}^{2}
- (a^{2} + u)(c^{2} + u) \, \tilde{y}^{2} - (a^{2} + u)(b^{2} + u) \, \tilde{z}^{2} \: .
\label{eq:cubic-equation-triaxial-ell}
\end{equation}
By analysing the signals of this cubic equation we conclude that:
\begin{equation}
u = \begin{cases}
d \to \infty \: &, \quad p(u) > 0 \\
-c^{2} \: &, \quad p(u) < 0 \\
-b^{2} \: &, \quad p(u) > 0 \\
-a^{2} \: &, \quad p(u) < 0
\end{cases} \: .
\label{eq:cubic-equation-signals-triaxial-ell}
\end{equation}
Notice that, according to \ref{eq:cubic-equation-signals-triaxial-ell},
the smaller, intermediate and largest roots of the cubic 
equation $p(u)$ (equation \ref{eq:cubic-equation-triaxial-ell}) are 
located, respectively, in the intervals $[ -a^{2} \, , -b^{2} ]$,
$[ -b^{2} \, , -c^{2} ]$ and $[ -c^{2} \, , \infty [$.
Remember that we are interested in a $u$ satisfying 
the condition expressed by equation \ref{eq:condition-triaxial-ell}. 
Consequently, according to the signal analysis shown in equation
\ref{eq:cubic-equation-signals-triaxial-ell}, we are interested in 
the largest root $\lambda$ of the cubic equation $p(u)$ (equation
\ref{eq:cubic-equation-triaxial-ell}).

From equation \ref{eq:cubic-equation-triaxial-ell}, we obtain a
simpler one given by
\begin{equation}
p(u) =  u^{u} + p_{2} \, u^{2} + p_{1} \, u + p_{0} \: ,
\label{eq:cubic-equation-triaxial-ell-simpler}
\end{equation}
where
\begin{equation}
p_{2} = a^{2} + b^{2} + c^{2} - \tilde{x}^{2} - \tilde{y}^{2} - \tilde{z}^{2} \: ,
\label{eq:p2-triaxial-ell}
\end{equation}
\begin{equation}
p_{1} = p_{1} =  ^{2} \, c^{2} + a^{2} \, c^{2} + a^{2} \, b^{2} 
- (b^{2} + c^{2}) \, \tilde{x}^{2}
- (a^{2} + c^{2}) \, \tilde{y}^{2} 
- (a^{2} + b^{2}) \, \tilde{z}^{2}
\label{eq:p1-triaxial-ell}
\end{equation}
and
\begin{equation}
p_{0} =  a^{2} \, b^{2} \, c^{2} - b^{2} \, c^{2} \, 
\tilde{x}^{2} - a^{2} \, c^{2} \, \tilde{y}^{2} - a^{2} \, 
b^{2} \, \tilde{z}^{2} \: .
\label{eq:p0-triaxial-ell}
\end{equation}
Finally, from equations \ref{eq:p2-triaxial-ell}, 
\ref{eq:p1-triaxial-ell} and \ref{eq:p0-triaxial-ell},
the largest root $\lambda$ of $p(u)$ 
(equation \ref{eq:cubic-equation-triaxial-ell}) can be 
calculated as follows \citep{weisstein2017}:
\begin{equation}
\lambda = 2 \, \sqrt{-Q} \, \cos \left( \frac{\theta}{3}\right) - \frac{p_{2}}{3} \: ,
\label{eq:lambda-triaxial-ell}
\end{equation}
where
\begin{equation}
\theta = \cos^{-1} \left( \frac{R}{\sqrt{Q^{3}}} \right) \: ,
\label{eq:theta-triaxial-ell}
\end{equation}
\begin{equation}
Q = \frac{3 \, p_{1} - p_{2}^{2}}{9}
\label{eq:Q-triaxial-ell}
\end{equation}
and
\begin{equation}
R = \frac{9 \, p_{1} \, p_{2} - 27 \, p_{0} - 2 \, p_{2}^{3}}{54} \: .
\label{eq:R-triaxial-ell}
\end{equation}

\subsection{Parameter $\lambda$ defining prolate and oblate ellipsoids} %% Appendix A1, A2, etc.

Let us now consider a prolate ellipsoid with semi-axes $a$, $b$, 
$c$ oriented along the $\tilde{x}$-, $\tilde{y}$-, and 
$\tilde{z}$-axis, respectively, of its local coordinate system, 
where $a > b = c > 0$. 

In this case, 


\authorcontribution{TEXT}

\begin{acknowledgements}
TEXT
\end{acknowledgements}


%% REFERENCES

%% The reference list is compiled as follows:

%%\begin{thebibliography}{}

%%\bibitem[AUTHOR(YEAR)]{LABEL}
%%REFERENCE 1

%%\bibitem[AUTHOR(YEAR)]{LABEL}
%%REFERENCE 2

%%\end{thebibliography}

%% Since the Copernicus LaTeX package includes the BibTeX style file copernicus.bst,
%% authors experienced with BibTeX only have to include the following two lines:
%%
\bibliographystyle{copernicus}
\bibliography{references}
%%
%% URLs and DOIs can be entered in your BibTeX file as:
%%
%% URL = {http://www.xyz.org/~jones/idx_g.htm}
%% DOI = {10.5194/xyz}


%% LITERATURE CITATIONS
%%
%% command                        & example result
%% \citet{jones90}|               & Jones et al. (1990)
%% \citep{jones90}|               & (Jones et al., 1990)
%% \citep{jones90,jones93}|       & (Jones et al., 1990, 1993)
%% \citep[p.~32]{jones90}|        & (Jones et al., 1990, p.~32)
%% \citep[e.g.,][]{jones90}|      & (e.g., Jones et al., 1990)
%% \citep[e.g.,][p.~32]{jones90}| & (e.g., Jones et al., 1990, p.~32)
%% \citeauthor{jones90}|          & Jones et al.
%% \citeyear{jones90}|            & 1990



%% FIGURES

%% ONE-COLUMN FIGURES

%%f
%\begin{figure}[t]
%\includegraphics[width=8.3cm]{FILE NAME}
%\caption{TEXT}
%\end{figure}
%
%%% TWO-COLUMN FIGURES
%
%%f
%\begin{figure*}[t]
%\includegraphics[width=12cm]{FILE NAME}
%\caption{TEXT}
%\end{figure*}
%
%
%%% TABLES
%%%
%%% The different columns must be seperated with a & command and should
%%% end with \\ to identify the column brake.
%
%%% ONE-COLUMN TABLE
%
%%t
%\begin{table}[t]
%\caption{TEXT}
%\begin{tabular}{column = lcr}
%\tophline
%
%\middlehline
%
%\bottomhline
%\end{tabular}
%\belowtable{} % Table Footnotes
%\end{table}
%
%%% TWO-COLUMN TABLE
%
%%t
%\begin{table*}[t]
%\caption{TEXT}
%\begin{tabular}{column = lcr}
%\tophline
%
%\middlehline
%
%\bottomhline
%\end{tabular}
%\belowtable{} % Table Footnotes
%\end{table*}
%
%
%%% NUMBERING OF FIGURES AND TABLES
%%%
%%% If figures and tables must be numbered 1a, 1b, etc. the following command
%%% should be inserted before the begin{} command.
%
%\addtocounter{figure}{-1}\renewcommand{\thefigure}{\arabic{figure}a}
%
%
%%% MATHEMATICAL EXPRESSIONS
%
%%% All papers typeset by Copernicus Publications follow the math typesetting regulations
%%% given by the IUPAC Green Book (IUPAC: Quantities, Units and Symbols in Physical Chemistry,
%%% 2nd Edn., Blackwell Science, available at: http://old.iupac.org/publications/books/gbook/green_book_2ed.pdf, 1993).
%%%
%%% Physical quantities/variables are typeset in italic font (t for time, T for Temperature)
%%% Indices which are not defined are typeset in italic font (x, y, z, a, b, c)
%%% Items/objects which are defined are typeset in roman font (Car A, Car B)
%%% Descriptions/specifications which are defined by itself are typeset in roman font (abs, rel, ref, tot, net, ice)
%%% Abbreviations from 2 letters are typeset in roman font (RH, LAI)
%%% Vectors are identified in bold italic font using \vec{x}
%%% Matrices are identified in bold roman font
%%% Multiplication signs are typeset using the LaTeX commands \times (for vector products, grids, and exponential notations) or \cdot
%%% The character * should not be applied as mutliplication sign
%
%
%%% EQUATIONS
%
%%% Single-row equation
%
%\begin{equation}
%
%\end{equation}
%
%%% Multiline equation
%
%\begin{align}
%& 3 + 5 = 8\\
%& 3 + 5 = 8\\
%& 3 + 5 = 8
%\end{align}
%
%
%%% MATRICES
%
%\begin{matrix}
%x & y & z\\
%x & y & z\\
%x & y & z\\
%\end{matrix}
%
%
%%% ALGORITHM
%
%\begin{algorithm}
%\caption{…}
%\label{a1}
%\begin{algorithmic}
%…
%\end{algorithmic}
%\end{algorithm}
%
%
%%% CHEMICAL FORMULAS AND REACTIONS
%
%%% For formulas embedded in the text, please use \chem{}
%
%%% The reaction environment creates labels including the letter R, i.e. (R1), (R2), etc.
%
%\begin{reaction}
%%% \rightarrow should be used for normal (one-way) chemical reactions
%%% \rightleftharpoons should be used for equilibria
%%% \leftrightarrow should be used for resonance structures
%\end{reaction}
%
%
%%% PHYSICAL UNITS
%%%
%%% Please use \unit{} and apply the exponential notation


\end{document}
