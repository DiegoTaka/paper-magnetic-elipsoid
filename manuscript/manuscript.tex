%% Copernicus Publications Manuscript Preparation Template for LaTeX Submissions
%% ---------------------------------
%% This template should be used for copernicus.cls
%% The class file and some style files are bundled in the Copernicus Latex Package which can be downloaded from the different journal webpages.
%% For further assistance please contact the Copernicus Publications at: publications@copernicus.org
%% http://publications.copernicus.org


%% Please use the following documentclass and Journal Abbreviations for Discussion Papers and Final Revised Papers.


%% 2-Column Papers and Discussion Papers
\documentclass[gmd, manuscript]{copernicus}



%% Journal Abbreviations (Please use the same for Discussion Papers and Final Revised Papers)

% Archives Animal Breeding (aab)
% Atmospheric Chemistry and Physics (acp)
% Advances in Geosciences (adgeo)
% Advances in Statistical Climatology, Meteorology and Oceanography (ascmo)
% Annales Geophysicae (angeo)
% ASTRA Proceedings (ap)
% Atmospheric Measurement Techniques (amt)
% Advances in Radio Science (ars)
% Advances in Science and Research (asr)
% Biogeosciences (bg)
% Climate of the Past (cp)
% Drinking Water Engineering and Science (dwes)
% Earth System Dynamics (esd)
% Earth Surface Dynamics (esurf)
% Earth System Science Data (essd)
% Fossil Record (fr)
% Geographica Helvetica (gh)
% Geoscientific Instrumentation, Methods and Data Systems (gi)
% Geoscientific Model Development (gmd)
% Geothermal Energy Science (gtes)
% Hydrology and Earth System Sciences (hess)
% History of Geo- and Space Sciences (hgss)
% Journal of Sensors and Sensor Systems (jsss)
% Mechanical Sciences (ms)
% Natural Hazards and Earth System Sciences (nhess)
% Nonlinear Processes in Geophysics (npg)
% Ocean Science (os)
% Proceedings of the International Association of Hydrological Sciences (piahs)
% Primate Biology (pb)
% Scientific Drilling (sd)
% SOIL (soil)
% Solid Earth (se)
% The Cryosphere (tc)
% Web Ecology (we)
% Wind Energy Science (wes)


%% \usepackage commands included in the copernicus.cls:
%\usepackage[german, english]{babel}
%\usepackage{tabularx}
%\usepackage{cancel}
%\usepackage{multirow}
%\usepackage{supertabular}
%\usepackage{algorithmic}
%\usepackage{algorithm}
%\usepackage{amsthm}
%\usepackage{float}
%\usepackage{subfig}
%\usepackage{rotating}


\begin{document}

\title{3D Magnetic modelling of ellipsoidal bodies}


% \Author[affil]{given_name}{surname}

\Author[1]{Diego}{Takahashi Tomazella}
\Author[1]{Vanderlei}{C. Oliveira Jr}

\affil[1]{Department of Geophysics, Observat\'{o}rio Nacional, Rio de Janeiro, Brazil}
%\affil[]{}

%% The [] brackets identify the author with the corresponding affiliation. 1, 2, 3, etc. should be inserted.



\runningtitle{TEXT}

\runningauthor{TEXT}

\correspondence{Diego Takahashi Tomazella (diego.takahashi@gmail.com)}



\received{}
\pubdiscuss{} %% only important for two-stage journals
\revised{}
\accepted{}
\published{}

%% These dates will be inserted by Copernicus Publications during the typesetting process.


\firstpage{1}

\maketitle



\begin{abstract}

TEXT

\end{abstract}



\introduction  %% \introduction[modified heading if necessary]

TEXT

\section{Methodology}

\subsection{Geometrical parameters and coordinate systems}

Let $(x, y, z)$ be a point referred to a Cartesian coordinate system with axes
$x$, $y$ and $z$ pointing to, respectively, North, East and down.
For convenience, we denominate this coordinate system as 
\textit{main coordinate system}.
Let us consider an ellipsoidal body with centre at the point $(x_{c}, y_{c}, z_{c})$,
semi-axes defined by positive constants $a$, $b$, $c$, 
where $a > b > c$, and orientation defined by
three angles $\alpha$, $\beta$, and $\gamma$.
The points $(x, y, z)$ located on the surface of this ellipsoidal body
satisfy the following equation:
\begin{equation}
(\mathbf{r} - \mathbf{r}_c)^T \mathbf{A} (\mathbf{r} - \mathbf{r}_c) = 1 \: ,
\label{eq:ellipsoid_surface}
\end{equation}
where $\mathbf{r} = [\begin{array}{ccc} x & y & z \end{array} ]^{\top}$,
$\mathbf{r}_{c} = [\begin{array}{ccc} x_{c} & y_{c} & z_{c} \end{array} ]^{\top}$,
$\mathbf{A}$ is a positive definite matrix given by
\begin{equation}
\mathbf{A} = \mathbf{V}
\left[ \begin{array}{ccc}
a^{-2} & 0 & 0 \\
0 & b^{-2} & 0 \\
0 & 0 & c^{-2} 
\end{array} \right] \mathbf{V}^{\top} \: ,
\label{eq:A}
\end{equation}
and $\mathbf{V}$ is an orthogonal matrix whose columns are defined
by unit vectors $\mathbf{v}_{1}$, $\mathbf{v}_{2}$, and $\mathbf{v}_{3}$.

The vectors $\mathbf{v}_{1}$, $\mathbf{v}_{2}$, and $\mathbf{v}_{3}$ 
depend on the orientation angles 
$\alpha$, $\beta$, $\gamma$ and are defined 
as follows \citep{clark1986}:
\begin{equation}
\mathbf{v}_{1} = \left[\begin{array}{c} 
                  -\cos\alpha \; \cos\delta \\
                  -\sin\alpha \; \cos\delta \\
                  -\sin\delta
                  \end{array} \right] \: ,
\label{eq:v1_triaxial_prolate}
\end{equation}
\begin{equation}
\mathbf{v}_{2} = \left[\begin{array}{c} 
                  \cos\alpha \; \cos\gamma \; \sin\delta + \sin\alpha \; \sin\gamma \\                   
                  \sin\alpha \; \cos\gamma \; \sin\delta - \cos\alpha \; \sin\gamma \\ 
                  -\cos\gamma \; \cos\delta
                  \end{array} \right] \: ,
\label{eq:v2_triaxial_prolate}
\end{equation}                   
\begin{equation}                    
\mathbf{v}_{3} = \left[\begin{array}{c} 
                  \sin\alpha \; \cos\gamma - \cos\alpha \; \sin\gamma \; \sin\delta \\                    
                  -\cos\alpha \; \cos\gamma - \sin\alpha \; \sin\gamma \; \sin\delta \\
                  \sin\gamma \; \cos\delta
                  \end{array} \right] \: .
\label{eq:v3_triaxial_prolate}
\end{equation}
For triaxial ellipsoids (i.e., $a > b > c$), the orthogonal matrix
$\mathbf{V}$ (Eq. \ref{eq:A}) is calculated by using Eqs.
\ref{eq:v1_triaxial_prolate}, \ref{eq:v2_triaxial_prolate}, and
\ref{eq:v3_triaxial_prolate} as follows:
\begin{equation}
\mathbf{V} = \left[ \begin{array}{ccc}
\mathbf{v}_{1} & \mathbf{v}_{2} & \mathbf{v}_{3}
\end{array} \right] \: .
\label{eq:V_triaxial_prolate}
\end{equation}
Similarly, the matrix $\mathbf{V}$ (Eq. \ref{eq:A}) for
prolate ellipsoids (i.e., $a > b = c$) is calculated according
to Equation \ref{eq:V_triaxial_prolate} by using Equations
\ref{eq:v1_triaxial_prolate}, \ref{eq:v2_triaxial_prolate}, and
\ref{eq:v3_triaxial_prolate}, but with $\gamma = 0^{\circ}$ 
\citep{emerson1985}.
Finally, the matrix $\mathbf{V}$ (Eq. \ref{eq:A}) for
oblate ellipsoids (i.e., $a < b = c$) is calculated by 
using Eqs. \ref{eq:v1_triaxial_prolate}, \ref{eq:v2_triaxial_prolate}, and
\ref{eq:v3_triaxial_prolate}, with $\gamma = 0^{\circ}$, as follows
\citep{emerson1985}:
\begin{equation}
\mathbf{V} = \left[ \begin{array}{ccc}
\mathbf{v}_{2} & \mathbf{v}_{1} & -\mathbf{v}_{3}
\end{array} \right] \: .
\label{eq:V_oblate}
\end{equation}
The orientation of the semi-axes $a$, $b$, and $c$ are defined 
by the first, second, and third columns of the matrix 
$\mathbf{V}$ given by Equation \ref{eq:V_triaxial_prolate},
in the case of a triaxial or prolate ellipsoid, or the
matrix $\mathbf{V}$ given by Equation \ref{eq:V_oblate},
in the case of an oblate ellipsoid.

The magnetic modelling of an ellipsoidal body is commonly performed
in a particular Cartesian coordinate system that is aligned 
with the body semi-axes
and has the origin coincident with the body centre.
For convenience, we denominate this particular coordinate 
system as \textit{local coordinate system}.
The relationship between the Cartesian coordinates 
$(\tilde{x}, \tilde{y}, \tilde{z})$ of a point in 
a local coordinate system and the Cartesian 
coordinates $(x, y, z)$ of the same point in the main
system is given by:
\begin{equation}
\tilde{\mathbf{r}} = \mathbf{V}^{\top} \left( \mathbf{r} - \mathbf{r}_{c} \right) \: ,
\label{eq:coord_transformation}
\end{equation}
where 
$\tilde{\mathbf{r}} = [\begin{array}{ccc} \tilde{x} & 
                                          \tilde{y} & 
                                          \tilde{z} \end{array} ]^{\top}$,
$\mathbf{r}$ and $\mathbf{r}_{c}$
are defined in Equation \ref{eq:ellipsoid_surface} and the matrix $\mathbf{V}$
is defined according to Eqs. \ref{eq:V_triaxial_prolate} or
\ref{eq:V_oblate}, depending on the ellipsoid type.
%Similarly, we may properly use the orthogonality of 
%matrix $\mathbf{V}$ to transform a generic 
%linear system $\mathbf{M} \mathbf{p} = \mathbf{d}$,
%referred to the main coordinate system, into a new
%linear system 
%$\tilde{\mathbf{M}} \, \tilde{\mathbf{p}} = \tilde{\mathbf{d}}$,
%referred to a local coordinate system, 
%as follows:
%\begin{equation}
%\underbrace{\mathbf{V}^{\top} \mathbf{M} \mathbf{V}}_{\tilde{\mathbf{M}}} \, 
%\underbrace{\mathbf{V}^{\top} \mathbf{p}}_{\tilde{\mathbf{p}}} = 
%\underbrace{\mathbf{V}^{\top} \mathbf{d}}_{\tilde{\mathbf{d}}} \: .
%\label{eq:matrix-transformation}
%\end{equation}

\subsection{Theoretical background}

Based on the mathematical theory of the magnetic 
induction developed by \citet{poisson1824}, 
\citet{maxwell1873} affirmed that, if $U$ is the 
gravitational potential produced by any body 
with uniform density $\rho$ and arbitrary shape at 
a point $(x, y, z)$, then $-\frac{\partial U}{\partial x}$
is the magnetic scalar potential produced 
at the same point by the same body 
if it has a uniform magnetization oriented along $x$ 
with intensity $\rho$.
\citet{maxwell1873} generalized this idea as a way
of determining the magnetic scalar potential produced
by any body uniformly magnetized in a given direction.
By presuming that this uniform magnetization is due to
induction, he postulated that the resulting magnetic
field (intensity) at all points within the body must
also be uniform and parallel the magnetization, which
results that the gravitational potential $U$ at points
within the body must be a quadratic function of the
spatial coordinates.
Apparently, \citet{maxwell1873} was the first one to
affirm that the only finite bodies having a gravitational
potential with this property and that, as a consequence,
can be uniformly magnetized in the presence of a uniform and 
static magnetic field are the ones bounded by surfaces 
of second degree, which are ellipsoids.

Consider a magnetized ellipsoid immersed in
a uniform magnetic field $\mathbf{H}_{0}$ (in $\unit{Am^{-1}}$).
This uniform field can be, for example, the main component of the
Earth's magnetic field, which is usually assumed to be generated
by the Earth's liquid core.
In the absence of conduction currents, 
the total magnetic field $\mathbf{H}(\mathbf{r})$
at the position $\mathbf{r}$ (Eqs. \ref{eq:A} and 
\ref{eq:coord_transformation}) of a point referred to the main 
coordinate system is defined as follows \citep{sharma1966, 
eskola1980, reitz1992, sttraton2007}:
\begin{equation}
\mathbf{H}(\mathbf{r}) = \mathbf{H}_{0} - \nabla V(\mathbf{r}) \: ,
\label{eq:H}
\end{equation}
where the second term is the negative gradient of 
the magnetic scalar potential $V(\mathbf{r})$ given by:
\begin{equation}
V(\mathbf{r}) = -\frac{1}{4\pi} \iiint_{\vartheta} 
\mathbf{M}(\mathbf{r}^{\prime})^{\top} 
\nabla \left(
\frac{1}{\| \mathbf{r} - \mathbf{r}^{\prime} \|}
\right) \, dx^{\prime}dy^{\prime}dz^{\prime} \: .
\label{eq:phi-potential}
\end{equation}
In this equation, $\mathbf{r}^{\prime} = [\begin{array}{ccc} 
x^{\prime} & y^{\prime} & z^{\prime} \end{array} ]^{\top}$
is the position vector of a point located within the volume $\vartheta$, 
the integral is conducted over the variables 
$x^{\prime}$, $y^{\prime}$ and, $z^{\prime}$ representing
the coordinates of a point located within the volume $\vartheta$
of the ellipsoid, $\| \cdot \|$ denotes the Euclidean norm and 
$\mathbf{M}(\mathbf{r}^{\prime})$ is the magnetization vector
(in $\unit{Am^{-1}}$).
Equation \ref{eq:phi-potential} is valid anywhere, 
independently if the position vector $\mathbf{r}$ represents
a point located inside or outside the magnetized body
\citep{dubois1896}.

Based on \citeauthor{maxwell1873}'s postulate, let us
assume that the body has a uniform magnetization given by
\begin{equation}
\mathbf{M} = \mathbf{K} \, \mathbf{H}^{\dagger} \: ,
\label{eq:M-KH}
\end{equation}
where $\mathbf{H}^{\dagger}$ is the resultant uniform magnetic field 
at any point within the body and $\mathbf{K}$ is a 
constant and symmetrical 2nd-order tensor representing the 
magnetic susceptibility of the body. In this case, Equation 
\ref{eq:H} can be rewritten as follows:
\begin{equation}
\mathbf{H}(\mathbf{r}) = \mathbf{H}_{0} 
- \mathbf{N}(\mathbf{r}) \, \mathbf{K} \, \mathbf{H}^{\dagger} \: ,
\label{eq:H-M-uniform}
\end{equation}
where $\mathbf{N}(\mathbf{r})$ is a symmetrical matrix whose
$ij$-element $n_{ij}(\mathbf{r})$ is given by
\begin{equation}
n_{ij}(\mathbf{r}) = - 
\frac{1}{4\pi} \frac{\partial^{2} \, f(\mathbf{r})}
{\partial r_{i} \, \partial r_{j}} 
\: , \quad i = 1, 2, 3 \: , 
\quad j = 1, 2, 3 \: ,
\label{eq:nij}
\end{equation}
$r_{1} = x$, $r_{2} = y$, $r_{3} = z$ are the elements of 
the position vector $\mathbf{r}$ (Eq. \ref{eq:ellipsoid_surface}), 
and
\begin{equation}
f(\mathbf{r}) = \iiint_{\vartheta} 
\frac{1}{\| \mathbf{r} - \mathbf{r}^{\prime} \|}
\, dx^{\prime}dy^{\prime}dz^{\prime} \: .
\label{eq:f}
\end{equation}
Notice that the scalar function $f(\mathbf{r})$ 
(Eq. \ref{eq:f}) is proportional
to the gravitational potential that would be produced by the 
ellipsoidal body with volume $\vartheta$ if it had a uniform density 
equal to the inverse of the gravitational constant.
It can be shown that the elements $n_{ij}(\mathbf{r})$ are
finite whether $\mathbf{r}$ is a point within or without
the volume $\vartheta$ \citep{peirce1902, webster1904}.
The matrix $\mathbf{N}(\mathbf{r})$ (Eq. \ref{eq:H-M-uniform})
is called \textit{depolarization tensor} \citep{soliverez1981, soliverez2008}.

The following part of this paper moves on to describe 
the magnetic field $\mathbf{H}(\mathbf{r})$ 
(Eq. \ref{eq:H-M-uniform}) at points located
both within and without the volume $\vartheta$ of the ellipsoidal
body. However, the mathematical developments are conveniently 
performed in the local coordinate system related to the
respective ellipsoidal body. 

\subsection{Coordinate transformation}

To continue our description of the magnetic modelling of 
ellipsoidal bodies, it is convenient to perform two 
important coordinate transformations. 
The first one transforms the scalar function 
$f(\mathbf{r})$ (Eq. \ref{eq:f}) from the 
main coordinate system into a new scalar function 
$\tilde{f}(\tilde{\mathbf{r}})$ referred to the
local coordinate system.
The function $\tilde{f}(\tilde{\mathbf{r}})$ was first 
presented by \citet{dirichlet1839} to describe the gravitational potential
produced by homogeneous ellipsoids.
Posteriorly, several authors also deduced and used this function
for describing the magnetic and gravitational fields produced
by triaxial, prolate, and oblate ellipsoids  
\citep{maxwell1873, thomson1879, dubois1896, 
peirce1902, webster1904, kellogg1929, stoner1945, osborn1945,
lowes1974,  peake1953, chang1961, clark1986, tejedor1995, sttraton2007}.
It is convenient to use $\tilde{f}^{\dagger}(\tilde{\mathbf{r}})$
and $\tilde{f}^{\ddagger}(\tilde{\mathbf{r}})$ to define 
the function $\tilde{f}(\tilde{\mathbf{r}})$ evaluated, 
respectively, at points 
$\tilde{\mathbf{r}}$ inside and outside the volume $\vartheta$ of the
ellipsoidal body.

The scalar function $\tilde{f}^{\dagger}(\tilde{\mathbf{r}})$
is given by
\begin{equation}
\tilde{f}^{\dagger}(\tilde{\mathbf{r}}) = \pi \, abc \, 
\int_{0}^{\infty} \left( 1 
- \frac{\tilde{x}^{2}}{a^{2} + u} 
- \frac{\tilde{y}^{2}}{b^{2} + u}
- \frac{\tilde{z}^{2}}{c^{2} + u} \right)
\frac{1}{R(u)} \, du \: , \quad \tilde{\mathbf{r}} \in V \: ,
\label{eq:fi-tilde}
\end{equation}
where
\begin{equation}
R(u) = \sqrt{\left( a^{2} + u \right)\left( b^{2} + u \right)\left( c^{2} + u \right)} \: .
\label{eq:R}
\end{equation}
This function represents the gravitational potential
that would be produced by the ellipsoidal body at
points located within its volume $\vartheta$ if it
had a uniform density equal to the inverse of the
gravitational constant.
Notice that, in this case, the gravitational potential
is a quadratic function of the spatial coordinates
$\tilde{x}$, $\tilde{y}$, and $\tilde{z}$, which
supported the \citeauthor{maxwell1873}'s (\citeyear{maxwell1873})
postulate about uniformly magnetized ellipsoids.
In a similar way, the function $\tilde{f}^{\ddagger}(\tilde{\mathbf{r}})$
is given by
\begin{equation}
\tilde{f}^{\ddagger}(\tilde{\mathbf{r}}) = \pi \, abc \, 
\int_{\lambda}^{\infty} \left( 1 
- \frac{\tilde{x}^{2}}{a^{2} + u} 
- \frac{\tilde{y}^{2}}{b^{2} + u}
- \frac{\tilde{z}^{2}}{c^{2} + u} \right)
\frac{1}{R(u)} \, du \: , \quad \tilde{\mathbf{r}} \not\in V \: ,
\label{eq:fe-tilde}
\end{equation}
where $R(u)$ is defined by Equation \ref{eq:R} and the
parameter $\lambda$ is defined according to the
ellipsoid type as a function of the spatial coordinates
 $\tilde{x}$, $\tilde{y}$, and $\tilde{z}$ (see Appendix B). 
For readers interested in additional information about the 
parameter $\lambda$, we recommend \citet[p.~234]{webster1904},
\citet[p.~184]{kellogg1929} and \citet{clark1986}.

The second important coordinate transformation is defined
with respect to Equation \ref{eq:H-M-uniform}.
By properly using the orthogonality of matrix $\mathbf{V}$ 
(Eqs. \ref{eq:V_triaxial_prolate} and \ref{eq:V_oblate}),
the magnetic field $\mathbf{H}(\mathbf{r})$ 
(Eq. \ref{eq:H-M-uniform}) can be transformed
from the main coordinate system to a local coordinate system
as follows:
\begin{equation}
\underbrace{\mathbf{V}^{\top} \mathbf{H}(\mathbf{r})}_{\tilde{\mathbf{H}}(\tilde{\mathbf{r}})} = 
\underbrace{\mathbf{V}^{\top} \mathbf{H}_{0}}_{\tilde{\mathbf{H}}_{0}}
- \underbrace{\mathbf{V}^{\top} \mathbf{N}(\mathbf{r}) \mathbf{V}}
_{\tilde{\mathbf{N}}(\tilde{\mathbf{r}})} \;
\underbrace{\mathbf{V}^{\top} \mathbf{K} \mathbf{V}}
_{\tilde{\mathbf{K}}} \; 
\underbrace{\mathbf{V}^{\top} \mathbf{H}^{\dagger}}
_{\tilde{\mathbf{H}}^{\dagger}} \: ,
\label{eq:H-tilde}
\end{equation}
where the superscript "$\sim$" denotes quantities
referred to the respective local coordinate system.

In Equation \ref{eq:H-tilde}, the transformed
depolarization tensor $\tilde{\mathbf{N}}(\tilde{\mathbf{r}})$
is calculated as a function of the original depolarization
tensor $\mathbf{N}(\mathbf{r})$ (Eq. \ref{eq:H-M-uniform}).
In this case, the elements of $\tilde{\mathbf{N}}(\tilde{\mathbf{r}})$
are calculated as a function of the second derivatives of the
function $f(\mathbf{r})$ (Eq. \ref{eq:f}),
which is defined in the main coordinate system.
It can be shown (Appendix A), however, that the
elements $\tilde{n}_{ij}(\tilde{\mathbf{r}})$ of
$\tilde{\mathbf{N}}(\tilde{\mathbf{r}})$ can also be calculated
as follows:
\begin{equation}
\tilde{n}_{ij}(\tilde{\mathbf{r}}) = - 
\frac{1}{4\pi} \frac{\partial^{2} \, \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{i} \, \partial \tilde{r}_{j}} 
\: , \quad i = 1, 2, 3 \: , \quad j = 1, 2, 3 \: ,
\label{eq:nij-tilde}
\end{equation}
where $\tilde{r}_{1} = \tilde{x}$, $\tilde{r}_{2} = \tilde{y}$, 
and $\tilde{r}_{3} = \tilde{z}$ are the elements of the
transformed vector $\tilde{\mathbf{r}}$ (Eq. \ref{eq:coord_transformation})
and $\tilde{f}(\tilde{\mathbf{r}})$ is given by Equation \ref{eq:fi-tilde}
or \ref{eq:fe-tilde}, depending if $\tilde{\mathbf{r}}$ represents a
point located within or without the volume $\vartheta$ of the
ellipsoidal body.

\subsection{Internal magnetic field and magnetization}

By considering $\tilde{\mathbf{r}}$ as a point within the
volume $\vartheta$ of the ellipsoid and using the Maxwell's postulate 
about the uniformity of the magnetic field $\mathbf{H}(\mathbf{r})$ 
inside ellipsoidal bodies, we can use Equation \ref{eq:H-tilde}
for defining the resultant uniform magnetic field $\tilde{\mathbf{H}}^{\dagger}$
inside the ellipsoidal body as follows:
\begin{equation}
\tilde{\mathbf{H}}^{\dagger} = 
\left( \mathbf{I} - \tilde{\mathbf{N}}^{\dagger} \, \tilde{\mathbf{K}} \right)^{-1}
\tilde{\mathbf{H}}_{0} \: ,
\label{eq:Hi-tilde}
\end{equation}
where $\mathbf{I}$ is the identity matrix and 
$\tilde{\mathbf{N}}^{\dagger}$ represents the
transformed depolarization tensor evaluated within 
the volume $\vartheta$ of the ellipsoidal body. The elements
of $\tilde{\mathbf{N}}^{\dagger}$ will be presented in a 
latter section.

Let us pre-multiply the uniform internal field $\tilde{\mathbf{H}}^{\dagger}$
(Eq. \ref{eq:Hi-tilde}) by the transformed 
susceptibility tensor $\tilde{\mathbf{K}}$ 
(Eq. \ref{eq:H-tilde}) to obtain
\begin{equation}
\begin{split}
\tilde{\mathbf{M}} 
&= \tilde{\mathbf{K}} 
\left( \mathbf{I} - \tilde{\mathbf{N}}^{\dagger} \, \tilde{\mathbf{K}} \right)^{-1}
\tilde{\mathbf{H}}_{0} \\
&=  
\left( \mathbf{I} - \tilde{\mathbf{K}} \, \tilde{\mathbf{N}}^{\dagger} \right)^{-1}
\tilde{\mathbf{K}} \, \tilde{\mathbf{H}}_{0}
\end{split} \: ,
\label{eq:M-tilde}
\end{equation}
where $\tilde{\mathbf{M}}$
represents the transformed magnetization, as can be easily
verified by using Eqs. \ref{eq:M-KH} and \ref{eq:H-tilde}.
The matrix identity used for obtaining the second line of Equation 
\ref{eq:M-tilde} is given by \citet[p. ~151]{searle1982}.

Equation \ref{eq:M-tilde} can be easily generalized for the case in 
which the ellipsoid has also a uniform remanent magnetization
$\tilde{\mathbf{M}}_{R}$. Let us first consider that
the uniform remanent magnetization satisfies the condition
$\tilde{\mathbf{H}}_{A} = \tilde{\mathbf{K}}^{-1} \tilde{\mathbf{M}}_{R}$,
where $\tilde{\mathbf{H}}_{A}$ represents a hypothetical 
uniform ancient field. Then, if we assume that $\tilde{\mathbf{H}}_{0}$,
in Eqs. \ref{eq:Hi-tilde} and \ref{eq:M-tilde},
is in fact the sum of the uniform magnetic field $\tilde{\mathbf{H}}_{0}$ 
and the hypothetical ancient field $\tilde{\mathbf{H}}_{A}$, we obtain the 
following generalized equation
\begin{equation}
\tilde{\mathbf{M}} =  
\left( \mathbf{I} - \tilde{\mathbf{K}} \, \tilde{\mathbf{N}}^{\dagger} \right)^{-1}
\left( \tilde{\mathbf{K}} \, \tilde{\mathbf{H}}_{0} + \tilde{\mathbf{M}}_{R} \right) \: .
\label{eq:M-tilde-remanence}
\end{equation}
Equation \ref{eq:M-tilde-remanence} is consistent with that given by
\citet[Eq. ~38]{clark1986}.

\subsection{External magnetic field and total-field anomaly}

The magnetic field $\Delta \tilde{\mathbf{H}}(\tilde{\mathbf{r}})$ 
produced by an ellipsoid at external points is calculated from 
Eqs. \ref{eq:H-tilde} and \ref{eq:M-tilde-remanence} as the difference
between the resultant field $\tilde{\mathbf{H}}(\tilde{\mathbf{r}})$ 
and the uniform field $\tilde{\mathbf{H}}_{0}$:
\begin{equation}
\Delta \tilde{\mathbf{H}}(\tilde{\mathbf{r}}) = 
- \tilde{\mathbf{N}}^{\ddagger}(\tilde{\mathbf{r}}) \, \tilde{\mathbf{M}} \: .
\label{eq:delta-H-tilde}
\end{equation}
The elements of the transformed depolarization tensor 
$\tilde{\mathbf{N}}^{\ddagger}(\tilde{\mathbf{r}})$ used in 
Equation \ref{eq:delta-H-tilde} will be presented in
the following section.

The $\Delta \tilde{\mathbf{H}}(\tilde{\mathbf{r}})$ 
can be interpreted as a uniformly magnetized body located in the
crust while the uniform field $\tilde{\mathbf{H}}_{0}$ can
be interpreted as the main component of the geomagnetic field
on the study area, which is commonly assumed to be
generated at the liquid part of the Earth's core.
Equation \ref{eq:delta-H-tilde} gives the magnetic field
(in \unit{A \, m^{-1}}) produced by an ellipsoid. However,
in geophysics, the most widely used field is the magnetic 
induction (in \unit{nT}). Fortunately, this conversion can
be easily done by multiplying Equation \ref{eq:delta-H-tilde}
by $k_{m}~=~10^{9}~\mu_{0}$, where $\mu_{0}$ represents the
magnetic constant (in \unit{H \, m^{-1}}).

For geophysical applications, it is preferable to
calculate the total-field anomaly produced by the
magnetic sources. This scalar quantity is defined 
as follows \citep{blakely1996}:
\begin{equation}
\Delta \tilde{T}(\tilde{\mathbf{r}}) = \| 
\tilde{\mathbf{B}}_{0} + \Delta \tilde{\mathbf{B}}(\tilde{\mathbf{r}}) \|
- \| \tilde{\mathbf{B}}_{0} \| \: ,
\label{eq:delta-T-tilde}
\end{equation}
where $\tilde{\mathbf{B}}_{0} = k_{m} \, \tilde{\mathbf{H}}_{0}$
and $\Delta \tilde{\mathbf{B}}(\tilde{\mathbf{r}}) = 
k_{m} \, \Delta \tilde{\mathbf{H}}(\tilde{\mathbf{r}})$
(Eq. \ref{eq:delta-H-tilde}).
In practical situations, however, 
$\| \tilde{\mathbf{B}}_{0} \| >> \| \Delta \tilde{\mathbf{B}}(\tilde{\mathbf{r}}) \|$
and, consequently, the following approximation is valid \citep{blakely1996}:
\begin{equation}
\Delta \tilde{T}(\tilde{\mathbf{r}}) \approx  
\frac{\tilde{\mathbf{B}}_{0}^{\top} \Delta \tilde{\mathbf{B}}(\tilde{\mathbf{r}})}{\| \tilde{\mathbf{B}}_{0} \|} \: .
\label{eq:delta-T-tilde-approx}
\end{equation}

\subsection{Transformed depolarization tensors $\tilde{\mathbf{N}}(\tilde{\mathbf{r}})$}

\subsubsection{Depolarization tensor $\tilde{\mathbf{N}}^{\dagger}$}

The elements of the transformed depolarization tensor 
$\tilde{\mathbf{N}}^{\dagger}$ used to compute the 
uniform magnetic field $\tilde{\mathbf{H}}^{\dagger}$
(Eq. \ref{eq:Hi-tilde}) and the magnetization $\tilde{\mathbf{M}}$ 
(Eqs. \ref{eq:M-tilde} and \ref{eq:M-tilde-remanence})
are calculated according to Equation \ref{eq:nij-tilde}, with 
$\tilde{f}(\tilde{\mathbf{r}})$ given by 
$\tilde{f}^{\dagger}(\tilde{\mathbf{r}})$ (Eq. \ref{eq:fi-tilde}).
As we have already pointed out, the  
$\tilde{f}^{\dagger}(\tilde{\mathbf{r}})$ (Eq. \ref{eq:fi-tilde}) is a
quadratic function of the spatial coordinates $\tilde{x}$,
$\tilde{y}$ and $\tilde{z}$. Consequently, the 
elements $\tilde{n}^{\dagger}_{ij}$, $i = 1, 2, 3$, 
$j = 1, 2, 3$, of $\tilde{\mathbf{N}}^{\dagger}$ 
do not depend on the transformed position
vector $\tilde{\mathbf{r}}$ (equation \ref{eq:coord_transformation}). 
Besides, the off-diagonal elements are zero and
the diagonal elements are given by \citep{stoner1945}:
\begin{equation}
\tilde{n}^{\dagger}_{ii} = \frac{abc}{2}
\int_{0}^{\infty} \frac{1}{\left( e_{i}^{2} 
+ u \right) R(u)} \, du \: , \quad i = 1, 2, 3 \: ,
\label{eq:n-tilde-dagger-ii}
\end{equation}
where $R(u)$ is defined by Equation \ref{eq:R} and
$e_{1} = a$, $e_{2} = b$, and $e_{3} = c$. These elements 
are commonly known as \textit{demagnetizing factors}
and are defined according to the ellipsoid type.
Notice that, according to Equations \ref{eq:H-tilde} 
and \ref{eq:N-tilde-VT-N-V},
\begin{equation}
\mathbf{N}(\mathbf{r}) = 
\mathbf{V} \, \tilde{\mathbf{N}}^{\dagger} \, 
\mathbf{V}^{\top} \: ,
\label{eq:N-V-N-dagger-VT}
\end{equation}
where $\tilde{\mathbf{N}}^{\dagger}$ (Eqs. \ref{eq:Hi-tilde}, 
\ref{eq:M-tilde} and \ref{eq:M-tilde-remanence}) is a diagonal 
matrix and $\mathbf{V}$ (Eqs. \ref{eq:V_triaxial_prolate} and
\ref{eq:V_oblate}) is an orthogonal matrix.
This equation shows that, for the particular case 
in which $\mathbf{r}$ and consequently $\tilde{\mathbf{r}}$
represent a point inside the
volume $\vartheta$ of the ellipsoid, the elements 
$\tilde{n}^{\dagger}_{ii}$ (Eq. \ref{eq:n-tilde-dagger-ii})
of $\tilde{\mathbf{N}}^{\dagger}$ represent the eigenvalues while the 
columns of $\mathbf{V}$ represent the eigenvectors of the 
original depolarization tensor $\mathbf{N}(\mathbf{r})$.


\subparagraph*{Triaxial ellipsoids}


For triaxial ellipsoids (e.g., $a > b > c$), the demagnetization
factors obtained by solving Equation \ref{eq:n-tilde-dagger-ii} 
are given by:
\begin{equation}
\tilde{n}^{\dagger}_{11} = \frac{abc}
{\left( a^{2} - c^{2} \right)^{\frac{1}{2}} 
\left( a^{2} - b^{2} \right)} 
\left[ F(\kappa, \phi) - E(\kappa, \phi) \right] \: ,
\label{eq:n-tilde-dagger-11-triaxial}
\end{equation}
\begin{equation}
\tilde{n}^{\dagger}_{22} = 
-\frac{abc}
{\left( a^{2} - c^{2} \right)^{\frac{1}{2}} 
\left( a^{2} - b^{2} \right)} 
\left[ F(\kappa, \phi) - E(\kappa, \phi) \right] + 
\frac{abc}
{\left( a^{2} - c^{2} \right)^{\frac{1}{2}} 
\left( b^{2} - c^{2} \right)} E(\kappa, \phi)
- \frac{c^{2}}{b^{2} - c^{2}}
\label{eq:n-tilde-dagger-22-triaxial}
\end{equation}
and
\begin{equation}
\tilde{n}^{\dagger}_{33} = 
-\frac{abc}
{\left( a^{2} - c^{2} \right)^{\frac{1}{2}} 
\left( b^{2} - c^{2} \right)} E(\kappa, \phi) +
\frac{b^{2}}{b^{2} - c^{2}} \: ,
\label{eq:n-tilde-dagger-33-triaxial}
\end{equation}
where $\kappa = \left[ \left( a^{2} - b^{2} \right) / 
\left( a^{2} - c^{2} \right) \right]^{\frac{1}{2}}$,
$\cos \phi = c/a$,
\begin{equation}
F(\kappa, \phi) = 
\int^{\phi}_{0} 
\frac{1}{\left( 1 - \kappa^{2} \sin^{2} \psi \right)^{\frac{1}{2}}}
d\psi \: ,
\label{eq:F-kappa-phi}
\end{equation}
and
\begin{equation}
E(\kappa, \phi) = 
\int^{\phi}_{0} 
\left( 1 - \kappa^{2} \sin^{2} \psi \right)^{\frac{1}{2}}
d\psi \: .
\label{eq:E-kappa-phi}
\end{equation}
The functions $F(\kappa, \phi)$ (Eq. \ref{eq:F-kappa-phi}) and 
$E(\kappa, \phi)$ (Eq. \ref{eq:E-kappa-phi}) are
called Legendre's normal elliptic integrals of the first and 
second kind, respectivelly. \citet{stoner1945} presented a 
detailed deduction of the demagnetization factors $\tilde{n}^{\dagger}_{11}$
(Eq. \ref{eq:n-tilde-dagger-11-triaxial}), $\tilde{n}^{\dagger}_{22}$
(Eq. \ref{eq:n-tilde-dagger-22-triaxial}) and $\tilde{n}^{\dagger}_{33}$
(Eq. \ref{eq:n-tilde-dagger-33-triaxial}). \citet{clark1986} presented similar
formulas, but without any proof.


\subparagraph*{Prolate ellipsoids}


For prolate ellipsoids (e.g., $a > b = c$), the demagnetization
factors obtained by solving Equation \ref{eq:n-tilde-dagger-ii} 
are given by:
\begin{equation}
\tilde{n}^{\dagger}_{11} = \frac{1}{m^{2} - 1}
\left\lbrace \frac{m}{\left( m^{2} - 1 \right)^{\frac{1}{2}}}
\ln \left[ m + \left( m^{2} - 1 \right)^{\frac{1}{2}} \right]
- 1 \right\rbrace
\label{eq:n-tilde-dagger-11-prolate}
\end{equation}
and
\begin{equation}
\tilde{n}^{\dagger}_{22} = \frac{1}{2} \left(1 - \tilde{n}^{\dagger}_{11} \right) \: ,
\label{eq:n-tilde-dagger-22-prolate}
\end{equation}
where $\tilde{n}^{\dagger}_{33} = \tilde{n}^{\dagger}_{22}$, 
which uses the $\tilde{n}^{\dagger}_{11}$ defined in 
Equation \ref{eq:n-tilde-dagger-11-prolate}, and $m = a/b$.
The detailed deduction of the demagnetization factors 
$\tilde{n}^{\dagger}_{11}$ (Eq. \ref{eq:n-tilde-dagger-11-prolate}) 
and $\tilde{n}^{\dagger}_{22}$ (Eq. \ref{eq:n-tilde-dagger-22-prolate})
can be found, for example, in \citet{stoner1945}. 
These formulas were posteriorly 
presented by \citet{emerson1985}, but without any mathematical proof.


\subparagraph*{Oblate ellipsoids}


For oblate ellipsoids (e.g., $a < b = c$), the demagnetization
factors obtained by solving Equation \ref{eq:n-tilde-dagger-ii} 
are given by:
\begin{equation}
\tilde{n}^{\dagger}_{11} = 
\frac{1}{1 - m^{2}} \left[
1 - \frac{m}{\left( 1 - m^{2} \right)^{\frac{1}{2}}} \cos^{-1}m
\right] \: ,
\label{eq:n-tilde-dagger-11-oblate}
\end{equation}
where $\tilde{n}^{\dagger}_{22}$ and $\tilde{n}^{\dagger}_{33}$ 
are calculated according to Equation
\ref{eq:n-tilde-dagger-22-prolate}, but with $\tilde{n}^{\dagger}_{11}$ 
defined in Equation \ref{eq:n-tilde-dagger-11-oblate}, 
and $m = a/b$.
The detailed deduction of these demagnetization factors 
can be found, for example, in \citet{stoner1945}. These formulas can also be found
in \citet{emerson1985}, but without any mathematical proof.
The only difference, however, is that \citet{emerson1985} replaced
the term $\cos^{-1}$ by a term $\tan^{-1}$, according to 
the trigonometric identity 
$\tan^{-1}x = \cos^{-1}(1/\sqrt{x^{2} + 1})$, $x > 0$.


\subsubsection{Depolarization tensor $\tilde{\mathbf{N}}^{\ddagger}(\tilde{\mathbf{r}})$}

The elements $\tilde{n}^{\ddagger}_{ij}(\tilde{\mathbf{r}})$,
$i = 1, 2, 3$, $j = 1, 2, 3$, of the transformed depolarization tensor 
$\tilde{\mathbf{N}}^{\ddagger}(\tilde{\mathbf{r}})$ used to compute
the magnetic field $\Delta \tilde{\mathbf{H}}(\tilde{\mathbf{r}})$ 
(Eq. \ref{eq:delta-H-tilde}) and
the total-field anomaly $\Delta \tilde{T}(\tilde{\mathbf{r}})$
(Eqs. \ref{eq:delta-T-tilde} and \ref{eq:delta-T-tilde-approx}) 
are calculated according to Equation \ref{eq:nij-tilde}, with 
$\tilde{f}(\tilde{\mathbf{r}})$ given by $\tilde{f}^{\ddagger}(\tilde{\mathbf{r}})$
(Eq. \ref{eq:fe-tilde}).

\begin{equation}
\tilde{n}^{\ddagger}_{ii}(\tilde{\mathbf{r}}) =
\frac{abc}{2}
\left( \frac{\partial \lambda}{\partial \tilde{r}_{i}} \, h_{i} \, \tilde{r}_{i}
- g_{i} \right)
\label{eq:n-tilde-dagger-ii}
\end{equation}

\begin{equation}
\tilde{n}^{\ddagger}_{ij}(\tilde{\mathbf{r}}) =
\frac{abc}{2} \left(
\frac{\partial \lambda}{\partial \tilde{r}_{i}} \, h_{j} \, \tilde{r}_{j} 
\right)
\label{eq:n-tilde-dagger-ij}
\end{equation}

\begin{equation}
h_{i} = \frac{1}{\left( e_{i}^{2} + \lambda \right) R(\lambda)}
\label{eq:hi}
\end{equation}

\begin{equation}
g_{i} = \int_{\lambda}^{\infty} \frac{1}{\left( e_{i}^{2} + u \right) R(u)} du
\label{eq:gi}
\end{equation}



\subparagraph*{Triaxial ellipsoids}



TEXT



\subparagraph*{Prolate and oblate ellipsoids}


TEXT




\conclusions  %% \conclusions[modified heading if necessary]
TEXT




\appendix
\section{Relationship between the derivatives of the functions $f(\mathbf{r})$ and $\tilde{f}(\tilde{\mathbf{r}})$}    %% Appendix A

Let $\tilde{f}(\tilde{\mathbf{r}})$ be the scalar
function obtained by transforming $f(\mathbf{r})$ 
(Eq. \ref{eq:f}) from the
main coordinate system to a local coordinate system.
For convenience, let us rewrite Equation 
\ref{eq:coord_transformation} as follows:
\begin{equation}
\tilde{r}_{k} = v_{k1} \, r_{1} + v_{k2} \, r_{2} + v_{k3} \, r_{3} + c_{k} \: ,
\label{eq:r-tilde-k}
\end{equation}
where $\tilde{r}_{k}$, $k = 1, 2, 3$, are the elements of the transformed
position vector $\tilde{\mathbf{r}}$ (Eq. \ref{eq:coord_transformation}),
$r_{j}$, $j = 1, 2, 3$, are the elements of the position vector
$\mathbf{r}$ (Eq. \ref{eq:ellipsoid_surface}),
$v_{kj}$, $j = 1, 2, 3$, are the elements of the matrix
$\mathbf{V}$ (Eq. \ref{eq:V_triaxial_prolate} or \ref{eq:V_oblate}),
and $c_{k}$ is a constant defined by the coordinates
$x_{c}$, $y_{c}$, and $z_{c}$ of the centre of the ellipsoidal body.

By considering the functions $f(\mathbf{r})$ 
(Eq. \ref{eq:f}) and $\tilde{f}(\tilde{\mathbf{r}})$
evaluated at the same point, but on different coordinate
systems, we have:
\begin{equation*}
\frac{\partial f(\mathbf{r})}{\partial r_{j}} = 
\frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{1}} \,
\frac{\partial \tilde{r}_{1}}{\partial r_{j}} +
\frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{2}} \,
\frac{\partial \tilde{r}_{2}}{\partial r_{j}} +
\frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{3}} \,
\frac{\partial \tilde{r}_{3}}{\partial r_{j}} \: ,
\quad j = 1, 2, 3 \: ,
\end{equation*}
which, from Equation \ref{eq:r-tilde-k}, can be given by
\begin{equation}
\frac{\partial f(\mathbf{r})}{\partial r_{j}} = 
v_{j1} \, \frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{1}} +
v_{j2} \, \frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{2}} +
v_{j3} \, \frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{3}} \: ,
\quad j = 1, 2, 3 \: .
\label{eq:df_drj}
\end{equation}

Now, by deriving $\frac{\partial f(\mathbf{r})}{\partial r_{j}}$
(Eq. \ref{eq:df_drj}) with respect to the $i$th element 
$r_{i}$ of the position vector $\mathbf{r}$ (Eq. \ref{eq:ellipsoid_surface}),
we obtain:
\begin{equation}
\begin{split}
\frac{\partial^{2} f(\mathbf{r})}{\partial r_{i} \, \partial r_{j}} &=
v_{j1} \, \frac{\partial}{\partial r_{i}} 
\left( \frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{1}} \right) +
v_{j2} \, \frac{\partial}{\partial r_{i}} 
\left( \frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{2}} \right) +
v_{j3} \, \frac{\partial}{\partial r_{i}} 
\left( \frac{\partial \tilde{f}(\tilde{\mathbf{r}})}{\partial \tilde{r}_{3}} \right) \\
&= v_{j1} \, \left( 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{1} \, \partial \tilde{r}_{1}} \, v_{i1} + 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{2} \, \partial \tilde{r}_{1}} \, v_{i2} + 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{3} \, \partial \tilde{r}_{1}} \, v_{i3} 
\right) + \\
&+ v_{j2} \, \left( 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{1} \, \partial \tilde{r}_{2}} \, v_{i1} + 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{2} \, \partial \tilde{r}_{2}} \, v_{i2} + 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{3} \, \partial \tilde{r}_{2}} \, v_{i3} 
\right) + \\
&+ v_{j3} \, \left( 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{1} \, \partial \tilde{r}_{3}} \, v_{i1} + 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{2} \, \partial \tilde{r}_{3}} \, v_{i2} + 
\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{3} \, \partial \tilde{r}_{3}} \, v_{i3} 
\right) \\
&= \left[ \begin{array}{ccc}
v_{j1} & v_{j2} & v_{j3}
\end{array} \right] \tilde{\mathbf{F}}(\tilde{\mathbf{r}})
\left[ \begin{array}{c}
v_{i1} \\ v_{i2} \\ v_{i3}
\end{array} \right]
\end{split} \: ,
\label{eq:d2f-dridrj}
\end{equation}
where $\tilde{\mathbf{F}}(\tilde{\mathbf{r}})$ is a $3 \times 3$
matrix whose $ij$-th element is 
$\frac{\partial^{2} \tilde{f}(\tilde{\mathbf{r}})}
{\partial \tilde{r}_{i} \, \partial \tilde{r}_{j}}$.
From Equation \ref{eq:d2f-dridrj}, we obtain
\begin{equation}
\mathbf{F}(\mathbf{r}) = \mathbf{V} \, 
\tilde{\mathbf{F}}(\tilde{\mathbf{r}}) \, \mathbf{V}^{\top} \: ,
\label{eq:F-V-F-tilde-VT}
\end{equation}
where $\mathbf{F}(\mathbf{r})$ is a $3 \times 3$
matrix whose $ij$-th element is 
$\frac{\partial^{2} f(\mathbf{r})}
{\partial r_{i} \, \partial r_{j}}$ and
$\mathbf{V}$ is defined by Eqs. 
\ref{eq:V_triaxial_prolate} or
\ref{eq:V_oblate}, depending on the ellipsoid
type. As one may noticed, the matrices $\mathbf{F}(\mathbf{r})$ and
$\tilde{\mathbf{F}}(\tilde{\mathbf{r}})$ represent the Hessians
of the functions $f(\mathbf{r})$ (Eq. \ref{eq:f})
and $\tilde{f}(\tilde{\mathbf{r}})$, respectively.
Besides, the depolarization tensor $\mathbf{N}(\mathbf{r})$
(Eq. \ref{eq:H-M-uniform}) can be 
rewritten by using the matrix $\mathbf{F}(\mathbf{r})$
as follows
\begin{equation}
\mathbf{N}(\mathbf{r}) = - \frac{1}{4 \pi} \mathbf{F}(\mathbf{r}) \: .
\label{eq:N-F}
\end{equation}
By properly using the orthogonality of the matrix
$\mathbf{V}$, we may rewrite Equation \ref{eq:F-V-F-tilde-VT}
as follows:
\begin{equation}
\tilde{\mathbf{F}}(\tilde{\mathbf{r}}) = \mathbf{V}^{\top} \, 
\mathbf{F}(\mathbf{r}) \, \mathbf{V} \: .
\label{eq:F-tilde-VT-F-V}
\end{equation}
Finally, by multiplying both sides of Equation \ref{eq:F-tilde-VT-F-V}
by $-\frac{1}{4 \pi}$ and using Equation \ref{eq:N-F},
we conclude that 
\begin{equation}
\tilde{\mathbf{N}}(\tilde{\mathbf{r}}) = 
\mathbf{V}^{\top} \, \mathbf{N}(\mathbf{r}) \, \mathbf{V} \: .
\label{eq:N-tilde-VT-N-V}
\end{equation}

\section{Parameter $\lambda$ and its spatial derivatives}    %% Appendix B

Here, we follow the reasoning presented by \citet{webster1904}
for analysing the parameter $\lambda$ which defines triaxial, prolate
and oblate ellipsoids.

\subsection{Parameter $\lambda$ defining triaxial ellipsoids} %% Appendix A1, A2, etc.

Let us consider an ellipsoid with semi-axes $a$, $b$, $c$ oriented along 
the $\tilde{x}$-, $\tilde{y}$-, and $\tilde{z}$-axis, respectively, 
of its local coordinate system, where $a > b > c > 0$. 
This ellipsoid is defined by the following equation:
\begin{equation}
\frac{\tilde{x}^{2}}{a^{2}} + \frac{\tilde{y}^{2}}{b^{2}} + \frac{\tilde{z}^{2}}{c^{2}} = 1 \: .
\label{eq:reference-triaxial-ell}
\end{equation}
A quadric surface (e.g., ellipsoid, hyperboloid of one sheet or
hyperboloid of two sheets) which is confocal with the ellipsoid 
defined in Equation \ref{eq:reference-triaxial-ell} can be 
described as follows:
\begin{equation}
\frac{\tilde{x}^{2}}{a^{2} + u} + \frac{\tilde{y}^{2}}{b^{2} + u} + \frac{\tilde{z}^{2}}{c^{2} + u} = 1 \: ,
\label{eq:quadric-confocal-triaxial-ell}
\end{equation}
where $u$ is a real number. Equation \ref{eq:quadric-confocal-triaxial-ell} 
represents an ellipsoid for $u$ satisfying the condition
\begin{equation}
u + c^{2} > 0 \: .
\label{eq:condition-triaxial-ell}
\end{equation}

Given $a$, $b$, $c$, and a $u$ satisfying \ref{eq:condition-triaxial-ell}, 
we may use \ref{eq:quadric-confocal-triaxial-ell} for determining a set of 
points $(x, y, z)$ lying on the surface of an ellipsoid which is confocal 
with that one defined in Equation \ref{eq:reference-triaxial-ell}. 
Now, consider the problem of determining the ellipsoid which is confocal 
with that one defined in \ref{eq:reference-triaxial-ell} and pass through 
a particular point $(\tilde{x}, \tilde{y}, \tilde{z})$. 
This problem consists in determining the real number $u$ that, 
given $a$, $b$, $c$, $\tilde{x}$, $\tilde{y}$, and $\tilde{z}$, 
satisfies Equation \ref{eq:quadric-confocal-triaxial-ell} and
the condition expressed by Equation \ref{eq:condition-triaxial-ell}.
By rearranging Equation \ref{eq:quadric-confocal-triaxial-ell}, 
we obtain the following cubic equation for $u$:
\begin{equation}
p(u) = (a^{2} + u)(b^{2} + u)(c^{2} + u) - (b^{2} + u)(c^{2} + u) \, \tilde{x}^{2}
- (a^{2} + u)(c^{2} + u) \, \tilde{y}^{2} - (a^{2} + u)(b^{2} + u) \, \tilde{z}^{2} \: .
\label{eq:cubic-equation-triaxial-ell}
\end{equation}
This cubic equation shows that:
\begin{equation}
u = \begin{cases}
d \to \infty \: &, \quad p(u) > 0 \\
-c^{2} \: &, \quad p(u) < 0 \\
-b^{2} \: &, \quad p(u) > 0 \\
-a^{2} \: &, \quad p(u) < 0
\end{cases} \: .
\label{eq:cubic-equation-signals-triaxial-ell}
\end{equation}
Notice that, according to \ref{eq:cubic-equation-signals-triaxial-ell},
the smaller, intermediate and largest roots of the cubic 
equation $p(u)$ (Eq. \ref{eq:cubic-equation-triaxial-ell}) are 
located, respectively, in the intervals $[ -a^{2} \, , -b^{2} ]$,
$[ -b^{2} \, , -c^{2} ]$ and $[ -c^{2} \, , \infty [$.
Remember that we are interested in a $u$ satisfying 
the condition expressed by Equation \ref{eq:condition-triaxial-ell}. 
Consequently, according to the signal analysis shown in Equation
\ref{eq:cubic-equation-signals-triaxial-ell}, we are interested in 
the largest root $\lambda$ of the cubic equation $p(u)$ (Eq.
\ref{eq:cubic-equation-triaxial-ell}).

From Equation \ref{eq:cubic-equation-triaxial-ell}, we obtain a
simpler one given by
\begin{equation}
p(u) =  u^{u} + p_{2} \, u^{2} + p_{1} \, u + p_{0} \: ,
\label{eq:cubic-equation-triaxial-ell-simpler}
\end{equation}
where
\begin{equation}
p_{2} = a^{2} + b^{2} + c^{2} - \tilde{x}^{2} - \tilde{y}^{2} - \tilde{z}^{2} \: ,
\label{eq:p2-triaxial-ell}
\end{equation}
\begin{equation}
p_{1} = b^{2} \, c^{2} + a^{2} \, c^{2} + a^{2} \, b^{2} 
- (b^{2} + c^{2}) \, \tilde{x}^{2}
- (a^{2} + c^{2}) \, \tilde{y}^{2} 
- (a^{2} + b^{2}) \, \tilde{z}^{2}
\label{eq:p1-triaxial-ell}
\end{equation}
and
\begin{equation}
p_{0} =  a^{2} \, b^{2} \, c^{2} - b^{2} \, c^{2} \, 
\tilde{x}^{2} - a^{2} \, c^{2} \, \tilde{y}^{2} - a^{2} \, 
b^{2} \, \tilde{z}^{2} \: .
\label{eq:p0-triaxial-ell}
\end{equation}
Finally, from Eqs. \ref{eq:p2-triaxial-ell}, 
\ref{eq:p1-triaxial-ell} and \ref{eq:p0-triaxial-ell},
the largest root $\lambda$ of $p(u)$ 
(Eq. \ref{eq:cubic-equation-triaxial-ell-simpler}) can be 
calculated as follows \citep{weisstein2017}:
\begin{equation}
\lambda = 2 \, \sqrt{-Q} \, \cos \left( \frac{\theta}{3}\right) - \frac{p_{2}}{3} \: ,
\label{eq:lambda-triaxial-ell}
\end{equation}
where
\begin{equation}
\theta = \cos^{-1} \left( \frac{R}{\sqrt{Q^{3}}} \right) \: ,
\label{eq:theta-triaxial-ell}
\end{equation}
\begin{equation}
Q = \frac{3 \, p_{1} - p_{2}^{2}}{9}
\label{eq:Q-triaxial-ell}
\end{equation}
and
\begin{equation}
R = \frac{9 \, p_{1} \, p_{2} - 27 \, p_{0} - 2 \, p_{2}^{3}}{54} \: .
\label{eq:R-triaxial-ell}
\end{equation}

\subsection{Parameter $\lambda$ defining prolate and oblate ellipsoids} %% Appendix A1, A2, etc.

Let us now consider a prolate ellipsoid with semi-axes $a$, $b$, 
$c$ oriented along the $\tilde{x}$-, $\tilde{y}$-, and 
$\tilde{z}$-axis, respectively, of its local coordinate system, 
where $a > b = c > 0$. 
In this case, the Equation defining the surface of the ellipsoid
is obtained by substituting $c = b$ in Equation \ref{eq:reference-triaxial-ell}.
Consequently, the equation defining the respective confocal quadric
surface is given by
\begin{equation}
\frac{\tilde{x}^{2}}{a^{2} + u} + \frac{\tilde{y}^{2} + \tilde{z}^{2}}{b^{2} + u} = 1
\label{eq:quadric-confocal-prolate-ell}
\end{equation}
and the new condition that must be fulfilled by the variable
$u$ so that Equation \ref{eq:quadric-confocal-prolate-ell}
represent an ellipsoid is
\begin{equation}
u + b^{2} > 0 \: .
\label{eq:condition-prolate-ell}
\end{equation}

Similarly to the case of a triaxial ellipsoid presented
in the previous subsection, we are interested in
determining the real number $u$ that, 
given $a$, $b$, $\tilde{x}$, $\tilde{y}$, and $\tilde{z}$, 
satisfies Equation \ref{eq:quadric-confocal-prolate-ell} and
the condition expressed by Equation \ref{eq:condition-prolate-ell}.
From Equation \ref{eq:quadric-confocal-prolate-ell}, 
we obtain the following quadratic equation for $u$:
\begin{equation}
p(u) = (a^{2} + u)(b^{2} + u) - (b^{2} + u) \, \tilde{x}^{2}
- (a^{2} + u) \, (\tilde{y}^{2} + \tilde{z}^{2}) \: .
\label{eq:quadratic-equation-prolate-ell}
\end{equation}
This equation shows that
\begin{equation}
u = \begin{cases}
d \to \infty \: &, \quad f(\rho) > 0 \\
-b^{2} \: &, \quad f(\rho) < 0 \\
-a^{2} \: &, \quad f(\rho) > 0
\end{cases}
\label{eq:quadratic-equation-signals-prolate-ell}
\end{equation}
and, consequently, that its two roots lie in the intervals
$[ -a^{2} \, , -b^{2} ]$ and $[ -b^{2} \, , \infty [$.
Therefore, according to the condition established by
Equation \ref{eq:condition-prolate-ell} and the signal analysis 
shown in Equation \ref{eq:quadratic-equation-signals-prolate-ell}, 
we are interested in the largest root $\lambda$ of the quadratic 
equation $p(u)$ (Eq. \ref{eq:quadratic-equation-prolate-ell}).

By properly manipulating Equation \ref{eq:quadratic-equation-prolate-ell},
we obtain a simpler one given by
\begin{equation}
p(u) =  u^{2} + p_{1} \, u + p_{0} \: ,
\label{eq:quadratic-equation-prolate-ell-simpler}
\end{equation}
where
\begin{equation}
p_{1} = a^{2} + b^{2} - \tilde{x}^{2} - \tilde{y}^{2} - \tilde{z}^{2}
\label{eq:p1-prolate-ell}
\end{equation}
and
\begin{equation}
p_{0} =  a^{2} \, b^{2} 
- b^{2} \, \tilde{x}^{2} 
- a^{2} \left( \tilde{y}^{2} + \tilde{z}^{2} \right) \: .
\label{eq:p0-prolate-ell}
\end{equation}
Finally, by using Eqs. \ref{eq:p1-prolate-ell} and
\ref{eq:p0-prolate-ell}, the largest root $\lambda$ of $p(u)$ 
(Eq. \ref{eq:quadratic-equation-prolate-ell-simpler}) can be 
easily calculated as follows:
\begin{equation}
\lambda = \frac{-p_{1} + \sqrt{p_{1}^{2} - 4 \, p_{0}}}{2} \: .
\label{eq:lambda-prolate-ell}
\end{equation}

In the case of oblate ellipsoids, the procedure for determining
the parameter $\lambda$ is very similar to this one for prolate
ellipsoids.
The semi-axes $a$, $b$, $c$ of oblate 
ellipsoids are defined so that $b = c > a > 0$
and the condition that must be fulfilled by 
the variable $u$ is $u + a^{2} > 0$.
In this case, the two roots of the resulting quadratic equation 
lie in the intervals $[ -b^{2} \, , -a^{2} ]$ and $[ -a^{2} \, , \infty [$.
Consequently, we are still interested in the largest root of
the quadratic equation for the variable $u$, which is also 
calculated by using Equation \ref{eq:lambda-prolate-ell}.

\subsection{Spatial derivative of the parameter $\lambda$}

The magnetic modelling of triaxial, prolate or oblate ellipsoids 
requires not only the parameter lambda defined by Eqs.
\ref{eq:lambda-triaxial-ell} and \ref{eq:lambda-prolate-ell},
but also its derivatives with respect to the spatial coordinates
$\tilde{x}$, $\tilde{y}$, and $\tilde{z}$.
Fortunately, the spatial derivatives of the parameter $\lambda$ 
can be calculated in a very similar way for all ellipsoid types.

Let us first consider a triaxial ellipsoid. In this case,
the spatial derivatives of $\lambda$ are given by
\begin{equation}
\frac{\partial \lambda}{\partial \tilde{r}_{j}} =
\frac{\frac{2 \, \tilde{r}_{j}}{\left( e_{j}^{2} + \lambda \right)}}{
\left( \frac{\tilde{x}}{a^{2} + \lambda}\right)^{2} +
\left( \frac{\tilde{y}}{b^{2} + \lambda}\right)^{2} + 
\left( \frac{\tilde{z}}{c^{2} + \lambda}\right)^{2}} \: , \quad j = 1, 2, 3 \: ,
\label{eq:dlambda}
\end{equation}
where 
$\tilde{r}_{1} = \tilde{x}$, $\tilde{r}_{2} = \tilde{y}$, $\tilde{r}_{3} = \tilde{z}$,
$e_{1} = a$, $e_{2} = b$, and $e_{3} = c$.
This equation can be determined directly from equation
\ref{eq:quadric-confocal-triaxial-ell}. 
The spatial derivatives of $\lambda$ in the case of
prolate or oblate ellipsoids can also be calculated by using
Equation \ref{eq:dlambda} for the particular case in
with $b = c$.


\authorcontribution{TEXT}

\begin{acknowledgements}
TEXT
\end{acknowledgements}


%% REFERENCES

%% The reference list is compiled as follows:

%%\begin{thebibliography}{}

%%\bibitem[AUTHOR(YEAR)]{LABEL}
%%REFERENCE 1

%%\bibitem[AUTHOR(YEAR)]{LABEL}
%%REFERENCE 2

%%\end{thebibliography}

%% Since the Copernicus LaTeX package includes the BibTeX style file copernicus.bst,
%% authors experienced with BibTeX only have to include the following two lines:
%%
\bibliographystyle{copernicus}
\bibliography{references}
%%
%% URLs and DOIs can be entered in your BibTeX file as:
%%
%% URL = {http://www.xyz.org/~jones/idx_g.htm}
%% DOI = {10.5194/xyz}


%% LITERATURE CITATIONS
%%
%% command                        & example result
%% \citet{jones90}|               & Jones et al. (1990)
%% \citep{jones90}|               & (Jones et al., 1990)
%% \citep{jones90,jones93}|       & (Jones et al., 1990, 1993)
%% \citep[p.~32]{jones90}|        & (Jones et al., 1990, p.~32)
%% \citep[e.g.,][]{jones90}|      & (e.g., Jones et al., 1990)
%% \citep[e.g.,][p.~32]{jones90}| & (e.g., Jones et al., 1990, p.~32)
%% \citeauthor{jones90}|          & Jones et al.
%% \citeyear{jones90}|            & 1990



%% FIGURES

%% ONE-COLUMN FIGURES

%%f
%\begin{figure}[t]
%\includegraphics[width=8.3cm]{FILE NAME}
%\caption{TEXT}
%\end{figure}
%
%%% TWO-COLUMN FIGURES
%
%%f
%\begin{figure*}[t]
%\includegraphics[width=12cm]{FILE NAME}
%\caption{TEXT}
%\end{figure*}
%
%
%%% TABLES
%%%
%%% The different columns must be seperated with a & command and should
%%% end with \\ to identify the column brake.
%
%%% ONE-COLUMN TABLE
%
%%t
%\begin{table}[t]
%\caption{TEXT}
%\begin{tabular}{column = lcr}
%\tophline
%
%\middlehline
%
%\bottomhline
%\end{tabular}
%\belowtable{} % Table Footnotes
%\end{table}
%
%%% TWO-COLUMN TABLE
%
%%t
%\begin{table*}[t]
%\caption{TEXT}
%\begin{tabular}{column = lcr}
%\tophline
%
%\middlehline
%
%\bottomhline
%\end{tabular}
%\belowtable{} % Table Footnotes
%\end{table*}
%
%
%%% NUMBERING OF FIGURES AND TABLES
%%%
%%% If figures and tables must be numbered 1a, 1b, etc. the following command
%%% should be inserted before the begin{} command.
%
%\addtocounter{figure}{-1}\renewcommand{\thefigure}{\arabic{figure}a}
%
%
%%% MATHEMATICAL EXPRESSIONS
%
%%% All papers typeset by Copernicus Publications follow the math typesetting regulations
%%% given by the IUPAC Green Book (IUPAC: Quantities, Units and Symbols in Physical Chemistry,
%%% 2nd Edn., Blackwell Science, available at: http://old.iupac.org/publications/books/gbook/green_book_2ed.pdf, 1993).
%%%
%%% Physical quantities/variables are typeset in italic font (t for time, T for Temperature)
%%% Indices which are not defined are typeset in italic font (x, y, z, a, b, c)
%%% Items/objects which are defined are typeset in roman font (Car A, Car B)
%%% Descriptions/specifications which are defined by itself are typeset in roman font (abs, rel, ref, tot, net, ice)
%%% Abbreviations from 2 letters are typeset in roman font (RH, LAI)
%%% Vectors are identified in bold italic font using \vec{x}
%%% Matrices are identified in bold roman font
%%% Multiplication signs are typeset using the LaTeX commands \times (for vector products, grids, and exponential notations) or \cdot
%%% The character * should not be applied as mutliplication sign
%
%
%%% EQUATIONS
%
%%% Single-row equation
%
%\begin{equation}
%
%\end{equation}
%
%%% Multiline equation
%
%\begin{align}
%& 3 + 5 = 8\\
%& 3 + 5 = 8\\
%& 3 + 5 = 8
%\end{align}
%
%
%%% MATRICES
%
%\begin{matrix}
%x & y & z\\
%x & y & z\\
%x & y & z\\
%\end{matrix}
%
%
%%% ALGORITHM
%
%\begin{algorithm}
%\caption{}
%\label{a1}
%\begin{algorithmic}
%
%\end{algorithmic}
%\end{algorithm}
%
%
%%% CHEMICAL FORMULAS AND REACTIONS
%
%%% For formulas embedded in the text, please use \chem{}
%
%%% The reaction environment creates labels including the letter R, i.e. (R1), (R2), etc.
%
%\begin{reaction}
%%% \rightarrow should be used for normal (one-way) chemical reactions
%%% \rightleftharpoons should be used for equilibria
%%% \leftrightarrow should be used for resonance structures
%\end{reaction}
%
%
%%% PHYSICAL UNITS
%%%
%%% Please use \unit{} and apply the exponential notation


\end{document}